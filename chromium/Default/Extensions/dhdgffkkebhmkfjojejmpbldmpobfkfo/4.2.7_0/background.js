'use strict';var trup,init,lfgs,sycl,cfgo,uris,clip,dast,perm,blak,scbr,exts,down;
Registry.require("promise statistics convert xmlhttprequest downloads cache storage uri compat parser layout helper syncinfo notify asker i18n native".split(" "),function(){var n=Registry.log,p=rea.FEATURES,ga=function(){var e=[],c=!0,h=function(e,d,b){var a={title:e.join("\n\n")};d.path=rea.extension.getURL("images/icon"+(d.frag?"_"+d.frag:"")+".png");n.warn(e.join("\n"));rea.browserAction.setIcon({path:d.path});rea.browserAction.setTitle(a);d=function(a,b,d){a={name:"1",sub_menu_item:!0,pos:"left",
items:[]};a.items.push({name:e[0],image:"info"});1<e.length&&a.items.push({name:e[1]});d({items:[a],options:{enabled:!1}})};b||rea.extension.onMessage.addListener(d)};return{run:function(){try{Registry.verify("5362").length&&(c=!1,h(["Tampermonkey detected that browser is caching some outdated code parts.","In order to avoid unexpected behavior TM will be kept paused until your browser was restarted."],{frag:"paused"}))}catch(d){c=!1,n.error(d.message)}if("chromeStorage"==p.DB.USE&&!p.DB.NO_WARNING){var e=
function(){if(!r)return window.setTimeout(e,2E3);r.isWorking().fail(function(){confirm("Tampermonkey detected that the extension storage is unreliable!\n\nUnfortunately this means that all your settings and userscripts are inaccessible at the moment.\n\nDo you want to visit the FAQ entry that explains how to recover from that?")&&rea.tabs.create({url:"http://tampermonkey.net/faq#Q206"},function(){});h(["Tampermonkey detected that the extension storage is unreliable!"],{frag:"paused"},!0)})};window.setTimeout(e,
1E3)}return c},pause:h,setWarning:function(c,d,b){e.push({text:c,description:d,url:b})},getWarnings:function(){return e}}}();if(ga.run()){var m=Registry.get("promise"),u=Registry.get("helper"),J=Registry.get("cache"),L=Registry.get("statistics"),r=Registry.get("storage"),Q=Registry.get("notify"),ca=Registry.get("asker"),M=Registry.get("native"),za=Registry.get("permission"),ra=Registry.get("layout"),B=Registry.get("uri"),c=Registry.get("i18n"),I=Registry.get("downloads");uris=B;down=I;perm=za;dast=
r;var sa=u.createUUID(),N={},W={};n.debug("Starting background fred @"+sa);J.create("rundata").setOptions({timeout:180,check_interval:120,retimeout_on_get:!0}).init();J.create("regexp").setOptions({timeout:3600,check_interval:120,retimeout_on_get:!0}).init();var Ba=function(){var e=m(),c,h,l=rea.extension.manifest.version,d=r.getSchemaVersion(),b=d;r.getVersion("0.0.0.0").then(function(a){h=a;c=y.versionCmp(l,h)==y.versionCmp.eNEWER;return r.isWiped()}).then(function(a){!c&&a&&(a=["Tampermonkey detected inconsistencies that indicate that your browser wiped the extension database!",
"You can continue to use Tampermonkey normally, but your settings and scripts might be lost. Click here to get more information.","http://tampermonkey.net/faq.php#Q207"],n.warn(a.join("\n")),ga.setWarning.apply(this,a))}).always(function(){var a=[],g=0,f=function(){if(g<a.length){var d=a[g].schema;a[g].cond(d)?a[g].fn().done(function(){d&&(n.log("Converted database from",b,"to",d),b=d);g++;f()}).fail(function(){e.reject()}):(g++,f())}},q=function(){n.warn("Incognito mode detected. Database conversion can only be done in non-incognito mode! Stopping now...");
ga.pause(["Tampermonkey needs to convert its database but this can't be done in incogonito mode!","Please open a non-incognito mode window and/or restart your browser."],{frag:"paused"})},a=[{cond:function(){return c&&!p.RUNTIME.FIREFOX&&!p.RUNTIME.EDGE&&"chromeStorage"==p.DB.USE&&!r.getValue(p.CONSTANTS.STORAGE.LEGACY_VERSION)&&y.versionCmp("3.5.3603",h)==y.versionCmp.eNEWER},fn:function(){var a=m();rea.extension.inIncognitoContext?(q(),a.reject()):(n.log("Update database..."),b="3.5.3603",r.migrate("sql",
"chromeStorage").done(function(){n.log("Copied config for default usage of chrome storage");a.resolve()}));return a.promise()}},{cond:function(){return c&&y.versionCmp("3.6.3650",b)==y.versionCmp.eNEWER&&y.versionCmp("3.5.3650",h)==y.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)q(),a.reject();else{b="3.6.3650";var g=[];[{o:"TM_config",n:p.CONSTANTS.STORAGE.CONFIG},{o:"TM_update_check",n:p.CONSTANTS.STORAGE.UPDATE},{o:"TM_version"},{o:"TM_unload_ts"}].forEach(function(a){if(a.n){var b=
r.getValue(a.o);void 0!==b&&g.push(r.setValue(a.n,b))}g.push(r.deleteValue(a.o))});var f=/@re$/,d=[];r.listValues().forEach(function(a){-1!=a.search(f)&&(a=a.replace(f,""),d.push(a))});d.forEach(function(a){var b=r.getValue(a+"@st"),f=r.getValue(a),d=r.getValue(a+"@re"),q=r.getValue(a+"@source"),e=A.getUidByName(a)||u.createUUID();g.push(r.deleteValue(a+"@st"));g.push(r.deleteValue(a));g.push(r.deleteValue(a+"@re"));g.push(r.deleteValue(a+"@source"));f&&d&&q?(g.push(r.setValue(p.CONSTANTS.PREFIX.SCRIPT_UID+
e,a)),g.push(r.setValue(p.CONSTANTS.PREFIX.COND+e,d)),g.push(r.setValue(p.CONSTANTS.PREFIX.STORE+e,b)),g.push(r.setValue(p.CONSTANTS.PREFIX.SCRIPT+e,q)),g.push(r.setValue(p.CONSTANTS.PREFIX.META+e,f))):n.warn("invalid script entry",{source:q,meta:f,cond:d})});f=/@st$/;r.listValues().forEach(function(a){-1!=a.search(f)&&g.push(r.deleteValue(a))});m.when(g).done(function(){n.log("Converted database from",h,"to",b);a.resolve()})}return a.promise()}},{schema:"3.7.0",cond:function(a){return y.versionCmp(a,
b)==y.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)q(),a.reject();else{var b=[],g=new RegExp("^"+p.CONSTANTS.PREFIX.META);r.listValues().forEach(function(a){if(-1!=a.search(g)){var f=r.getValue(a);f.options&&f.options.override&&!f.options.override.orig_run_at&&(f.options.override.orig_run_at=f.options.run_at||"document-idle",f.options.run_at=null,b.push(r.setValue(a,f)))}});m.when(b).done(function(){a.resolve()})}return a.promise()}},{schema:"4258",cond:function(a){return y.versionCmp(a,
b)==y.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)q(),a.reject();else{var b=r.getValue(p.CONSTANTS.STORAGE.CONFIG);b&&b.sync_enabled&&2==b.sync_type&&(b.sync_version=1,r.setValue(p.CONSTANTS.STORAGE.CONFIG,b));a.resolve()}return a.promise()}},{schema:"4526",cond:function(a){return c&&p.RUNTIME.SAFARI&&"chromeStorage"==p.DB.USE&&y.versionCmp(a,b)==y.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)q(),a.reject();else{n.log("Update database...");
var b=r.migrate("localStorage","chromeStorage").done(function(){n.log("Copied config for default usage of setting storage")});a.consume(b)}return a.promise()}},{schema:"4871",cond:function(a){return c&&y.versionCmp(a,b)==y.versionCmp.eNEWER},fn:function(){var a=m(),b,g,f=r.getValue(p.CONSTANTS.STORAGE.CONFIG);f&&f.scriptTemplate&&(g=k.getDefaults())&&(b=g.script_templates)&&b[0]&&b[0].value&&(b[0].value=f.scriptTemplate,delete f.scriptTemplate,r.setValue(p.CONSTANTS.STORAGE.CONFIG,f));a.resolve();
return a.promise()}},{cond:function(){return c||y.versionCmp(b,d)==y.versionCmp.eNEWER},fn:function(){var a=m();r.setVersion(l,b).done(function(){a.resolve()});return a.promise()}},{cond:function(){return c},fn:function(){n.log("First run of version "+l+"!");Aa.scheduleNotification(h,"0.0.0.0"==h);return m.Pledge()}},{cond:function(){return!0},fn:function(){var a=m();e.resolve();window.setTimeout(a.resolve,p.MISC.TIMEOUT);return a.promise()}}];f()});return e.promise()},da=function(){return{get:function(e,
c){var h=(0==e)+"#"+c,l=J.items.rundata.getj(h);if(l)l=l.oldret;else{var l=[],d=0,b={};if(c)for(var a=t.determineScriptsToRun(c),g=0;g<a.length;g++){var f=a[g];f.enabled?f.evilness&&f.evilness>=k.values.script_blacklist_severity||0!=e&&(!0===f.options.noframes||null===f.options.noframes&&!0===f.options.override.orig_noframes)||t.isContexter(f)||(b[f.name]=!0,l.push(f)):d++}l={runners:l,disabled:d,script_map:b};c&&J.items.rundata.setj(h,{frameId:e,oldret:l})}return l},answer:function(e,c){var h=u.select(e,
function(a){return a}),l=[{m:"native",t:[I.staticVars.DEFAULT,I.staticVars.NATIVE]},{m:"disabled",t:[I.staticVars.OFF]},{m:"browser",t:[I.staticVars.CHROME]}].filter(function(a){if(-1!=a.t.indexOf(k.values.downloads_mode))return!0}).map(function(a){return a.m})[0]||"disabled",d=rea.extension.inIncognitoContext,b=!d&&"off"!=k.values.external_connect&&t.validUrl(c,ta.externally_connectable_reg);return{scripts:h,contexters:ha.getContexterCount(),raw:{},external_connect:b,inIncognitoContext:d,downloadMode:l,
enforce_strict_mode:"on"==k.values.runtime_strict_mode,measure_scripts:k.values.debug,logLevel:k.values.logLevel,version:rea.extension.manifest.version}},getContexters:function(e,c){for(var h=[],l=t.determineScriptsToRun(c),d=0;d<l.length;d++){var b=l[d];b.enabled&&(0==e||!0!==b.options.noframes&&(null!==b.options.noframes||!0!==b.options.override.orig_noframes))&&t.isContexter(b)&&h.push(b)}return h}}}(),C=function(){var e={},c=1,h=c++,l=c++,d=c++,b=c++,a=c++,g=c++,f=c++,q=function(){var a={frames:{0:{state:h}},
tabs:{reset_ts:Date.now()},scripts:{},urls:{},maps:{},contexts:{onUnload:{}},stats:{running:0,disabled:0},extra:{}};Object.defineProperties(a.urls,{length:{value:0,enumerable:!1,writable:!0,configurable:!0}});return a},z={updateStats:function(a,b,g,f){e[a].stats.running+=g;e[a].stats.disabled+=f;e[a].contexts.onUnload[b]=e[a].contexts.onUnload[b]||[];e[a].contexts.onUnload[b].push(function(){e[a].stats.running-=g;e[a].stats.disabled-=f});e[a].tabs.ts=Date.now()},updateMaps:function(a,b,g){var f=1,
d=function(b,g){void 0===e[a].maps[g]&&1===f&&(e[a].maps[g]=0);e[a].maps[g]+=f};u.each(g,d);e[a].contexts.onUnload[b]=e[a].contexts.onUnload[b]||[];e[a].contexts.onUnload[b].push(function(){e[a]&&(f=-1,u.each(g,d))})},updateUrls:function(a,b,g){var f=function(f){1===f&&(void 0===e[a].urls[g]?e[a].urls[g]={frameId:b,count:0}:0===b&&(e[a].urls[g].frameId=b));e[a].urls[g].count+=f;e[a].urls.length=-1};f(1);e[a].contexts.onUnload[b]=e[a].contexts.onUnload[b]||[];e[a].contexts.onUnload[b].push(function(){e[a]&&
f(-1)})},determine:function(a,b,g){var f=null;X.isAllowed(g)?f=g:(n.debug("This URL is filtered by the security settings:",g,"-> Do nothing!"),C.set.forbidden(a,b));b=da.get(b,f);e[a].scripts[g]=b;return b.runners.length},run:function(a,b,g,f,d){a=[];for(b=0;b<f.length;b++)a.push(ua.bundle({url:g},f[b]));var q;m.when(a).always(function(a){d?d(a):q=a});return q}},v={},w={},E={},P={},K={listeners:{once:{whenReady:function(a,b){if(!e[a]||e[a].frames[0].state<d)K.listeners.once.onReady(a,b);else b()},
onReady:function(a,b){var g=function(a){K.listeners.remove.onCommited(f);K.listeners.remove.onCompleted(d);a&&b()},f=K.listeners.add.onCommited(function(b){b===a&&g(!0)}),d=K.listeners.add.onCompleted(function(b){b===a&&g(!0)})}},add:{onReset:function(a){var b=u.createUUID();v[b]=a;return b},onCommited:function(a){var b=u.createUUID();w[b]=a;return b},onCompleted:function(a){var b=u.createUUID();E[b]=a;return b},onRemoved:function(a){var b=u.createUUID();P[b]=a;return b}},remove:function(){return{onReset:function(a){delete v[a]},
onCommited:function(a){delete w[a]},onCompleted:function(a){delete E[a]},onRemoved:function(a){delete P[a]}}}()},events:{reset:function(a,b){e[a]=q();e[a].frames[0].state=h;u.each(v,function(g){g&&g(a,b)})},response:function(a,b,g){if(k.values.enabled){e[a]=e[a]||q();e[a].frames[b]=e[a].frames[b]||{};var f=e[a].frames[b].state||h;0===b&&(e[a].tabs.response_ts=Date.now());g=B.woHash(g);f<l&&(z.determine(a,b,g),e[a].frames[b].state=l);return(a=e[a].scripts[g])?a.runners.length:0}},commited:function(a,
b,g){if(k.values.enabled){var f=B.parse(g);if("http:"===f.protocol||"https:"===f.protocol||"file:"===f.protocol)e[a]=e[a]||q(),e[a].frames[b]=e[a].frames[b]||{},f=e[a].frames[b].state||h,f>=d||(e[a].frames[b].state=d,f<l&&(g=B.woHash(g),z.determine(a,b,g)),u.each(w,function(b){b&&b(a)}))}},loading:function(a,g,f){if(k.values.enabled){var d=B.parse(f);"http:"!==d.protocol&&"https:"!==d.protocol&&"file:"!==d.protocol||0!==g||"file:"!==d.protocol||(e[a]=e[a]||q(),e[a].frames[g]=e[a].frames[g]||{},d=
e[a].frames[g].state||h,d>=b||(e[a].frames[g].state=b,d<l&&(f=B.woHash(f),z.determine(a,g,f))))}},run:function(b,g,f,d,c){if(k.values.enabled){var w=0===g||p.RUNTIME.EXEC_SCRIPT_SUPPORT||p.RUNTIME.FAST_EXEC_SUPPORT?g:f;e[b]=e[b]||q();e[b].frames[w]=e[b].frames[w]||{};if(p.RUNTIME.FAST_EXEC_SUPPORT&&e[b].frames[w].exec)c&&c();else{var h=B.woHash(d),l=e[b].scripts[h];if(!l&&(n.debug("tv: lazy init @ events.run("+b+", "+g+", "+f+", "+d+")"),z.determine(b,g,h),l=e[b].scripts[h],!l)){n.warn("tv: no script run info for tab "+
b+" @ "+h,n.D?e[b].scripts:"");return}f=e[b].frames[w].state;e[b].frames[w].state=a;f!=a&&(z.updateMaps(b,w,l.script_map),z.updateUrls(b,w,h),z.updateStats(b,w,l.runners.length,l.disabled));return z.run(b,g,h,l.runners,c?function(a){K.events.exec(b,w,d);c(a)}:null)}}},exec:function(a,b,g){k.values.enabled&&e[a]&&(g=B.woHash(g),delete e[a].scripts[g],e[a].frames[b]&&(e[a].frames[b].exec=!0))},complete:function(b,f,d){d=B.parse(d);if(k.values.enabled&&("http:"===d.protocol||"https:"===d.protocol||"file:"===
d.protocol)){if(0===f){e[b]=e[b]||q();e[b].frames[f]=e[b].frames[f]||{};var c=e[b].frames[f].state||h;e[b].frames[f].state=g;if(!C.get.empty(b)&&C.get.stats(b).running){if(c<a){n.warn("tv: no script run info!");return}"file:"===d.protocol?window.setTimeout(function(){rea.tabs.sendMessage(b,{method:"onLoad",frameId:f},function(){})},500):rea.tabs.sendMessage(b,{method:"onLoad",frameId:f},function(){})}}u.each(E,function(a){a&&a(b)})}},unload:function(a,b,g){b=0===b||p.RUNTIME.EXEC_SCRIPT_SUPPORT||
p.RUNTIME.FAST_EXEC_SUPPORT?b:g;e[a]=e[a]||q();e[a].frames[b]=e[a].frames[b]||{};e[a].frames[b].state=f;if(e[a]&&e[a].contexts.onUnload[b]){for(g=0;g<e[a].contexts.onUnload[b].length;g++)e[a].contexts.onUnload[b][g]();e[a].contexts.onUnload[b]=[]}},remove:function(a){delete e[a];u.each(P,function(b){b&&b(a)})}},set:{extra:function(a,b,g,f){e[a]=e[a]||q();null===b?e[a].extra[g]=f:(e[a].extra[g]=e[a].extra[g]||{},e[a].extra[g][b]=f)},blocker:function(a){K.set.extra(a,null,"blocker",!0)},forbidden:function(a,
b){0===b&&K.set.extra(a,null,"forbidden",!0)}},get:{extra:function(a,b,g,f){void 0===f&&(f=null);var d=null,d=(e[a]?e[a].extra:{})[g];null!==b&&d&&(d=d[b]);return d||f},empty:function(a){var b=!0;if(e[a]&&0!=e[a].urls.length){if(-1==e[a].urls.length)return e[a].urls.length=0,u.each(e[a].urls,function(b,g){"length"!==g&&0<b.count&&e[a].urls.length++}),K.get.empty(a);b=!1}return b},urls:function(a){return e[a]?e[a].urls:{}},stats:function(a,b){var g={};if(e[a]&&(g.running=e[a].stats.running,g.disabled=
e[a].stats.disabled,b)){g.unique=0;for(var f in e[a].maps)e[a].maps.hasOwnProperty(f)&&0<e[a].maps[f]&&g.unique++}return g},tabs:function(){var a={};u.each(e,function(b,g){a[g]={ts:b.response_ts}});return a},blocker:function(a){return K.get.extra(a,null,"blocker")},forbidden:function(a){return K.get.extra(a,null,"forbidden")},exec:function(a,b){return e[a]&&e[a].frames[b]&&e[a].frames[b].exec}}};return K}(),ka=function(){return{isScriptUrl:function(e){if(!e||-1!=e.search(/\#bypass=true/)||-1!=e.search(p.REQUESTS.GET_INTERNAL_PAGE_REGEXP())||
"data:"===e.substr(0,5))return!1;e=e.split(/[\?#$]/)[0];var c=-1!=e.search(/.+\.user\.(js\#|js\?|js$)/)||-1!=e.search(/.+\.tamper\.(js\#|js\?|js$)/);return c?!(-1!=e.search(/^htt[ps]{1,2}:\/\/code\.google\.com/)||-1!=e.search(/^htt[ps]{1,2}:\/\/github\.com/)&&!t.determineOriginOfUrl(e)):c}}}(),va=function(){var e=function(e){var c=m(),l=Date.now();e.url+=-1!=e.url.search("\\?")?"&":"?";e.url+="ts="+l;var l=function(a){if(4==a.readyState&&(200==a.status||0==a.status))if("arraybuffer"==d.responseType){if(a.response){c.resolve({decoded:!0,
encoding:e.encoding,content:H.arrbuf2str(a.response,e.encoding)});return}}else if(null!==a.response&&void 0!==a.response){c.resolve({decoded:!0,encoding:e.encoding,content:a.response});return}c.reject({content:""})},d={method:"GET",retries:0,responseType:"arraybuffer",url:e.url};if(e.sync){var b=T(d,{});4==b.readyState&&0==b.status&&b.error&&(delete d.responseType,b=T(d,{}));l(b)}else T(d,{ondone:l});return c.promise()};return{getSource:function(c){"string"===typeof c&&(c={url:c});return e(c)}}}();
lfgs=va;var X=function(){return{init:function(){var e=function(){J.items.regexp.remove("PageFilter")};k.addChangeListener("forbiddenPages",e);k.addChangeListener("page_whitelist",e);k.addChangeListener("page_filter_mode",e)},isAllowed:function(e){var c=!1,h=!1,l=0!=k.values.forbiddenPages.length,d=0!=k.values.page_whitelist.length;switch(k.values.page_filter_mode){case "black":h=l;break;case "off":break;case "white":c=d;break;default:c=d,h=l}(l=J.items.regexp.get("PageFilter"))||(l=t.regexify({inc:c?
k.values.page_whitelist:void 0,exc:h?k.values.forbiddenPages:void 0}),J.items.regexp.set("PageFilter",l));return!h&&!c||t.validUrl(e,l)}}}(),R=function(){var e=function(e,c){var d=!1;if(c.length)return(d="/"==c.substr(0,1)?t.matchUrl(e,t.convertToRegExp(c)):-1!=e.search(c))&&n.debug('black: entry "'+c+'" matched'),d},x={init:function(){var e=m(),c=function(){"server"===k.values.script_blacklist_type&&window.setTimeout(x.checkUpdate,2E4)};c();k.addChangeListener("script_blacklist_type",c);e.resolve();
return e.promise()},getWarningsFor:function(h){var l=[];h&&u.each(k.values.script_blacklist_server,function(d){if(d){var b=c.getUiLocale(),a;u.each(d.rules,function(b){a|=e(h,b);return 1!=a});a&&(d.reasons?l.push(d.reasons[b]||d.reasons.en):d.reason&&l.push(d.reason))}});return l},getEvilnessOf:function(c){if("off"===k.values.script_blacklist_type)return!1;if(!c)return 0;var l=!1,d=0;u.each(k.values.require_blacklist,function(b){l|=e(c,b);return 1!=l});l?d=11:"server"===k.values.script_blacklist_type&&
u.each(k.values.script_blacklist_server,function(b){if(b&&(u.each(b.rules,function(a){l|=e(c,a);return 1!=l}),l))return d=b.severity,!1});return Number(d)},checkUpdate:function(e){var c=m(),d=Y.getConfig(),b;if(e||6048E5<Date.now()-d.black.last){var a=function(a,b){var d=m();T({method:"GET",url:a,nocache:b,retries:p.XMLHTTPREQUEST.RETRIES,overrideMimeType:"text/plain; charset=x-user-defined"},{ondone:function(a){d.resolve(a)}});return d.promise()};a("https://blacklist.tampermonkey.net/get.php?version=get").then(function(g){if(4==
g.readyState&&200==g.status){try{b=JSON.parse(g.responseText).version}catch(f){n.warn("black: unable to parse version response! "+g.responseText)}n.info("black: local version: "+d.black.version+" remote: "+b);if(b>d.black.version||e)return a("https://blacklist.tampermonkey.net/get.php",!0)}}).then(function(a){if(a&&4==a.readyState&&200==a.status)try{var b=JSON.parse(a.responseText);b&&b.blacklist&&1==b.version&&(k.values.script_blacklist_server=b.blacklist);n.info("black: updated blacklist to ",b)}catch(d){n.warn("black: blacklist update failed! ",
a.responseText)}}).always(function(){d=Y.getConfig();d.black.last=Date.now();d.black.version=b||d.black.version;Y.setConfig(d);c.resolve()})}else c.resolve();return c.promise()}};return x}();blak=R;var Ca=function(){for(var e=[],c=[],h=0;h<e.length;h++){var l=Registry.getRaw("system/"+e[h]+".tamper.js");l&&c.push(l)}return c},G=function(){var e=0,x=[],h={to:null,force:null,t:0},l={},d=function(a){n.debug("sync: import",a.uuid,a.name,a.url);var b={imported:k.values.sync_type},g={},f;for(f in v.SYNCED)!0===
v.SYNCED[f]&&(g[f]=a.options[f]);return t.installFromUrl(a.url,{uuid:a.uuid,ask:!1,internal:!0,sync:b,force_options:g},{silent_fail:!0})},b=function(a){n.debug("sync: export",a.name,a.url);return F.add(a)},a=function(a){var b=a.downloadURL?a.downloadURL.split("#")[0]:null,g=a.fileURL?a.fileURL.split("#")[0]:null,f=u.select([g,b],function(a){if(!a||"file:"!==B.parse(a).protocol)return a})[0],b={uuid:a.uuid,name:a.name,options:{},durl:b,furl:g,url:f},d;for(d in v.SYNCED)!0===v.SYNCED[d]&&null!==a.options[d]&&
(b.options[d]=a.options[d]);return b},g=function(){var b=[];A.getUidList().forEach(function(g){g=A.getByUid(g);g.script&&g.cond&&b.push(a(g.script))});return b},f=function(a){if(v.enabled)if(0<e)a&&v.addSyncDoneCallback(function(b){b&&v.sync(50,a)});else{e++;var f=null,q=null,h=!0,z={},p=function(a){if(a){(a=a.split("#")[0])&&(a=a.toLowerCase());for(var b=0;b<f.length;b++){var g=f[b].furl?f[b].furl.toLowerCase():null,d=f[b].durl?f[b].durl.toLowerCase():null;if(g==a||d==a)return f[b]}}return null},
r=function(a){if(a)for(var b=0;b<q.length;b++)if(q[b].uuid==a)return q[b];return null},u=function(a){if(a){a=a.split("#")[0];for(var b=0;b<q.length;b++)if(q[b].url==a)return q[b]}return null},y=function(a){if(!a)return null;for(var b=0;b<f.length;b++)if(f[b].uuid==a)return f[b]};(function(){f=g();return F.list().done(function(a){q=a}).fail(function(){n.warn("sync: unable to get remotelist!")})})().then(function(){for(var a=m(),b=[],g=0;g<q.length;g++)b.push(function(){var a,b=q[g],f=!1,e=!1,h=2==
k.values.sync_version?y(b.uuid):p(b.url);if(h)if(f=!0,z[b.url]=!0,b.uuid&&(z[b.uuid]=!0),b.content&&H.MD5(b.content)!=H.MD5(h.textContent))e=!0;else for(a in v.SYNCED)if(!0===v.SYNCED[a]&&h.options[a]!=b.options[a]){e=!0;break}if(f)if(b.options.removed)n.debug("sync: remove local script",b.uuid,b.name,b.url),t.doRemove(h.uuid,!1);else if(e)if(n.debug("sync: update local script",b.uuid,b.name,b.url),e=A.getByUid(h.uuid),e.script&&e.cond){for(a in v.SYNCED)!0===v.SYNCED[a]&&(e.script.options[a]=b.options[a]);
b.content&&(e.script.textContent=b.content);t.doModify(e.script.uuid,e.script,!1)}else n.warn(c.getMessage("fatal_error")+"("+h.name+")!!!");if(!f&&!b.options.removed)if(a=m(),l[b.url]||b.uuid&&l[b.uuid])n.warn("sync: skip previously failed import",b);else return d(b).done(function(a){a||(n.warn("sync: unable to import",b),l[b.url]=!0,b.uuid&&(l[b.uuid]=!0))}).fail(function(){n.warn("sync: unable to load",b);l[b.url]=!0;b.uuid&&(l[b.uuid]=!0)}).always(a.resolve),a.promise();return m.Pledge()}());
m.when(b).done(function(){a.resolve()});return a.promise()}).then(function(){f=g();return m.Pledge()}).then(function(){if(!F.isWritable())return m.Pledge();for(var a=m(),g=[],d=0;d<f.length;d++)g.push(function(){var a=f[d],g=!1;if(!a.url||z[a.url]||z[a.uuid])return m.Pledge();if(2==k.values.sync_version?r(a.uuid):u(a.url))g=!0;return g?m.Pledge():b(a).done(function(a){})}());m.when(g).done(function(){a.resolve()});return a.promise()}).fail(function(){h=!1}).done(function(){h=!0}).always(function(){n.debug("sync: finished");
if(0==--e)for(var a=h;x.length;)x.shift()(a)})}},q=function(){v.enabled&&v.sync(500,!0)},z=null,v={enabled:!1,SYNCED:{comment:!0},createTeslaData:function(){for(var a=m(),b=[],f=g(),d=0;d<f.length;d++)if(f[d].url){var e=JSON.stringify(f[d].options),e=f[d].name.replace(/\|/g,"!")+"|"+e+"|"+f[d].url.replace(/\|/g,"%7C");b.push(e)}a.resolve(b);return a.promise()},configChangeListener:function(){z||(z=window.setTimeout(function(){z=null;v.init().done(function(){v.enabled&&v.sync(3E3)})},3E3))},init:function(){var a=
m();v.enabled=!1;(function(){return k.values.sync_enabled&&k.values.sync_type?F.init(k.values.sync_type,k.values.sync_version,k.values.sync_id).done(function(a){v.enabled=a;v.enabled?F.addChangeListener(q):n.warn("sync: init failed!")}):m.Pledge()})().always(function(){a.resolve(v.enabled)});return a.promise()},finalize:function(){},reset:function(){return F.reset()},addSyncDoneCallback:function(a){x.push(a)},sync:function(a,b){var g=Date.now();a=a||500;b=h.force||b;h.to?(window.clearTimeout(h.to),
h.ts<g+a&&(a=h.ts-g,1>a&&(a=1))):n.debug("sync: schedule sync for run in "+a+" ms");h.force=b;h.ts=g+a;h.to=window.setTimeout(function(){f(h.force);h.to=null;h.force=null},a)},scriptAddedCb:function(g,f){if(v.enabled&&F.isWritable()){var d=a(f);d.url&&B.parse(d.url).protocol.match(/https?:/)&&b(d)}},scriptChangedCb:function(g,f,d){if(v.enabled&&F.isWritable()&&(g=a(f),g.url))for(var e in v.SYNCED)if(!0===v.SYNCED[e]&&f.options[e]!=d.options[e]){b(g);break}},scriptRemovedCb:function(b,g){if(v.enabled&&
F.isWritable()){var f=a(g);f.url&&(n.debug("sync: remove",f.name,f.url),F.remove(f))}}};return v}();sycl=G;var Da=function(){k.addChangeListener("sync_enabled",G.configChangeListener);k.addChangeListener("sync_type",G.configChangeListener);k.addChangeListener("sync_id",G.configChangeListener);k.addChangeListener("sync_version",G.configChangeListener);k.addChangeListener("logLevel",function(){n.set(k.values.logLevel)});k.addChangeListener("i18n",function(){c.setLocale(k.values.i18n)});k.addChangeListener("native_import_path",
function(){M.setPath(k.values.native_import_path)});k.addChangeListener("incognito_mode",function(){wa()});k.addChangeListener("statistics_enabled",function(){L.setEnabled(k.values.statistics_enabled)});k.addChangeListener("require_blacklist",t.blackCheckAll);k.addChangeListener("script_blacklist_server",t.blackCheckAll);k.addChangeListener("script_blacklist_type",t.blackCheckAll);k.addChangeListener("downloads_extension_whitelist",I.config_changed_listener);k.addChangeListener("downloads_mode",I.config_changed_listener);
k.addChangeListener("webrequest_modHeaders",function(e,c,h,l){l.done(window.setTimeout(U.reset,1))})},k=function(){var e={},c={enabled:!0,configMode:0,debug:!1,logLevel:0,showFixedSrc:!1,webrequest_modHeaders:"yes",webrequest_fixCSP:"yes",notification_showUpdate:"changelog",notification_silentScriptUpdate:!0,script_templates:[{name:"ECMAScript 5",value:"// ==UserScript==\n// @name         New Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  try to take over the world!\n// @author       You\n// @match        <$URL$>\n// @grant        none\n// ==/UserScript==\n\n(function() {\n    'use strict';\n\n    // Your code here...\n})();"},
{name:"ECMAScript 6",value:'// ==UserScript==\n// @name         New ES6-Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  shows how to use babel compiler\n// @author       You\n// @require      https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.18.2/babel.js\n// @require      https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/6.16.0/polyfill.js\n// @match        <$URL$>\n// ==/UserScript==\n\n/* jshint ignore:start */\nvar inline_src = (<><![CDATA[\n/* jshint ignore:end */\n    /* jshint esnext: false */\n    /* jshint esversion: 6 */\n\n    // Your code here...\n\n/* jshint ignore:start */\n]]\x3e</>).toString();\nvar c = Babel.transform(inline_src, { presets: [ "es2015", "es2016" ] });\neval(c.code);\n/* jshint ignore:end */'},
{name:"CoffeeScript",value:"// ==UserScript==\n// @name         New Coffee-Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  shows how to use coffeescript compiler\n// @author       You\n// @require      http://coffeescript.org/extras/coffee-script.js\n// @match        <$URL$>\n// ==/UserScript==\n/* jshint ignore:start */\nvar inline_src = (<><![CDATA[\n\n    // Your code here\n\n]]\x3e</>).toString();\nvar compiled = this.CoffeeScript.compile(inline_src);\neval(compiled);\n/* jshint ignore:end */"}],
scriptUpdateCheckPeriod:864E5,scriptUpdateHideNotificationAfter:15E3,scriptUpdateCheckDisabled:!1,scriptUrlDetection:"auto",runtime_strict_mode:"byscript",runtime_inject_mode:"default",runtime_inject_delay:10,autoReload:!1,appearance_badges:"running",appearance_badge_color:"gcal"===rea.runtime.short_id?"#444":"#ee3131",editor_enabled:!0,editor_fontSize:100,editor_theme:"default",editor_keyMap:"windows",editor_indentUnit:4,editor_indentWithTabs:!1,editor_tabMode:"indent",editor_electricChars:!0,editor_autoSave:!1,
editor_easySave:!0,editor_autoLint:!0,editor_autoLintMaxLen:5E4,editor_lineWrapping:!1,editor_highlightTrailingWhitespace:!0,native_import:!0,native_import_path:null,native_import_post_action:"disable",i18n:null,action_menu_columns:2<=p.ACTIONMENU.COLUMNS?2:1,action_menu_scripts_hide_disabled:!1,action_menu_scripts_sort:"position",incognito_mode:"temporary",layout:"default",sync_enabled:!1,sync_type:2,sync_version:2,sync_id:"",statistics_enabled:!0,downloads_mode:"default",downloads_extension_whitelist:"/^[^\\.]*$/ /\\.mp[34]$/ .wav /\\.(avi|mkv|flv|divx|mpe?g|webm)$/ /\\.(ico|gif|png|jpe?g)/ /\\.(srt|sub|idx)$/ .txt .iso .zip /\\.r(ar|[0-9]{2,2})$/".split(" "),
external_update_interval:6048E5,external_connect:"all",require_timeout:2E4,require_blacklist:["/^https?:\\/\\/example.com(:[0-9]{1,5})?\\/.*/"],require_sri_mode:"supported",script_blacklist_server:[],script_blacklist_type:"server",script_blacklist_severity:4,connect_mode:"ask",page_filter_mode:"black",page_whitelist:["/https?:\\/\\/greasyfork\\.org\\/.*/","http://xkcd.com/970/"],forbiddenPages:"*example.org/* *paypal.tld/* *stripe.com/* https://*deutsche-bank-24.tld/* https://*bankofamerica.tld/* /^.*:\\/\\/apis\\.google\\.com\\/((?!render)([^\\/]+)\\/)+([^\\/]+)?$/ *://www.facebook.com/plugins/* *://platform.twitter.com/widgets/*".split(" ")},
h=function(d,b){var a=r.getValue(p.CONSTANTS.STORAGE.CONFIG,{}),g=void 0===a[d]?c[d]:a[d];a[d]=b;var f=r.setValue(p.CONSTANTS.STORAGE.CONFIG,a);e[d]&&JSON.stringify(g)!=JSON.stringify(b)&&e[d].forEach(function(a){try{a(d,g,b,f)}catch(e){n.warn("config: changeListener error",e)}})},l={init:function(){var d=m();l.values={};l.__defineGetter__("snapshot",function(){return u.assign({},l.values)});for(var b in c)c.hasOwnProperty(b)&&function(){var a=b;l.values.__defineGetter__(a,function(){var b=r.getValue(p.CONSTANTS.STORAGE.CONFIG,
{});return void 0===b[a]?c[a]:b[a]});l.values.__defineSetter__(a,function(b){h(a,b)})}();l.initialized=!0;var a=Ca();Object.keys(a).forEach(function(b){var f=a[b];window.setTimeout(function(){t.doSave({url:null,src:f,ask:!1,replace:!0,internal:!0})},1)});d.resolve();return d.promise()},getDefaults:function(){return c},addChangeListener:function(d,b){e[d]||(e[d]=[]);e[d].push(b)}};return l}(),T=function(e,c){return ia(e,c,{internal:!0})},ea=function(){var e={},c=function(a){var b=a.split(".");if(3>
b.length||B.isIp(a))return a;a=B.isSecondLevelDomain(b.slice(-2).join("."))?-3:-2;return b.slice(a).join(".")},h=function(a){return a&&-1!=a.indexOf("*")},l=function(){var a=m();rea.tabs.getSelected(null,function(b){a.resolve(b)});return a.promise()},d=function(a){var b=m();X.isAllowed(a)?b.resolve({allowed:!0}):b.resolve({allowed:!1});return b.promise()},b=function(a,b){var g=function(a){return a?a.map(function(a){if(a.match(/^'?self'?$/))a=B.parse(b.url).hostname||null;else if("'none'"==a)a="none";
else if(-1===["none","localhost","*"].indexOf(a)&&(1>a.indexOf(".")||1===(a.match(/\./g)||[]).length&&B.isSecondLevelDomain(a)))return null;return a}):[]};return{connects:a.options.override.merge_connects&&"paranoid"!=k.values.connect_mode?g(a.connects):[],userconnects:g(a.options.override.use_connects),blockers:g(a.options.override.use_blockers)}},a=function(a,b,g){var f=m(),d=function(){f.resolve({permitted:!0})},c=function(a){f.resolve({permitted:!1,reason:a})},q=function(){f.resolve({unknown:!0})},
l,z=function(a,b){var g=null,f=B.isIp(a);b.every(function(b){if(b.a)for(var e=0;e<b.a.length;e++)if(b.a[e]&&(f?b.a[e]===a:-1!=a.search(new RegExp("(^|.+\\.)"+u.escapeForRegExp(b.a[e])+"$"))))return g=b.blocker?c:d,!1;return!0});return g};if("off"==k.values.connect_mode)d();else if((l=B.parse(g))&&l.hostname)if((g=z(l.hostname,[{a:e[a.uuid]}]))||(g=h(e[a.uuid])?d:null))g();else if(0===b.connects.length&&0===b.userconnects.length&&0===b.blockers.length)"casual"==k.values.connect_mode?d():"strict"==
k.values.connect_mode?c("No @connects given, but strict mode enabled"):q();else if(-1!=b.connects.indexOf("none"))c("None value found");else{if("casual"!=k.values.connect_mode||h(b.blockers)||!(g=h(b.connects)?d:null))(g=h(b.userconnects)?d:null)||(g=z(l.hostname,[{a:b.blockers,blocker:!0},{a:b.connects},{a:b.userconnects}])||q);g()}else c("URL can not be parsed");return f.promise()},g=function(){var a=function(a){for(var b=0;b<q.length;b++)if(q[b].tabId===a)return q.splice(b,1)[0];return q.pop()},
b;l().then(function(g){for(;!f&&(b=a(g.id));)b.fn()})},f,q=[],z=function(a,b,d,k,z){var v,p=m(),r=function(){p.resolve({approved:!0})},u=function(){p.resolve({forbidden:!0})};n.debug('cor: "'+a.name+'" is asking for permission to access',k,b);if((v=B.parse(k))&&v.hostname){var y=c(v.hostname),A=b.tab?b.tab.id:null;f=!0;l().then(function(g){return ca.askForConnect({src_url:b.url,hostname:v.hostname,domain:y,all_domains:h(d.connects),tabid:A,active:A===g.id,timeout:z,url:k,settings_url:rea.extension.getURL("options.html")+
"#nav="+a.uuid+"+settings",connect_url:"http://tampermonkey.net/documentation.php#_connect",script:{name:a.name,uuid:a.uuid,icon:a.icon64||a.icon||rea.extension.getURL("images/txt.png")}})}).done(function(b){var g,f=b.whole_domain?y:v.hostname;b.allow?b.once?(n.debug('cor: allowing "'+a.name+'" to access',f,"once"),r()):b.temporary?(n.debug('cor: allowing "'+a.name+'" to access',f,"temporarily"),void 0===e[a.uuid]&&(e[a.uuid]=[]),-1==e[a.uuid].indexOf(f)&&e[a.uuid].push(f),r()):(g=r,b.all_domains?
(n.debug('cor: allowing "'+a.name+'" to access all domains always'),a.options.override.use_connects.push("*")):(n.debug('cor: allowing "'+a.name+'" to access',f,"always"),a.options.override.use_connects.push(f),g=r)):b.once||b.aborted?(n.debug('cor: denying "'+a.name+'" to access',f,"once"),u()):(a.options.override.use_blockers||(a.options.override.use_blockers=[]),g=u,b.all_domains?(n.debug('cor: denying "'+a.name+'" to access any domains (additional) domain'),a.options.override.use_blockers.push("*")):
(n.debug('cor: denying "'+a.name+'" to access',f,"always"),a.options.override.use_blockers.push(f)));g&&t.doModify(a.uuid,a,!1).always(g)}).fail(u).always(function(){f=!1;q.length&&window.setTimeout(g,1)})}else u();return p.promise()},v=function(g,e,c,l){var x=b(g,e),p=arguments;return d(c).then(function(b){if(!0!==b.allowed)return m.Breach("URL is blacklisted");var f,d;return(f=B.parse(c))&&f.origin&&(d=B.parse(e.url))&&d.origin&&f.origin===d.origin?m.Pledge({permitted:!0}):a(g,x,c)}).then(function(a){if(!1===
a.permitted)return m.Breach("URL is not permitted"+(a.reason?": "+a.reason:""));if(!0===a.permitted)return m.Pledge();if(0===x.connects.length||h(x.connects)){if(-1==["ask","paranoid"].indexOf(k.values.connect_mode))return m.Breach();if(h(x.blockers))return m.Breach("URL was permanently blocked by the user");if(f){n.debug('cor: queuing access permission check from "'+g.name+'" to',c,e);var b=m();q.push({tabId:e.tab?e.tab.id:null,fn:function(){b.consume(v.apply(this,p))}});return b.promise()}return z(g,
e,x,c,l).then(function(a){return!0===a.approved?m.Pledge():m.Breach("Request was blocked by the user")})}return m.Breach("URL is not a part of the @connect list")})};return{getSessionConnects:function(a){return e[a]||[]},setSessionConnects:function(a,b){e[a]=b||[]},purgeAppeals:function(a){q=q.filter(function(b){return b.tabId!==a})},exec:function(a,b,g,f){var d,e,c,q,h=a.url,l=[],k=Math.max(Math.min(a.timeout||0,6E4),2E4),z=function(){for(var a;!c&&!q&&(a=l.shift());)a()},m=function(b,g){var d='Refused to connect to "'+
(g||a.url)+'": '+(b||"Blocked by @connect CORS check"),e=la.makeErrorResponse(d);["onerror","ondone"].forEach(function(a){if(f[a])f[a]({response:e,exception:d})})};if(!(g&&g.url&&g.tab&&a.url&&b&&(e=A.getByUid(b))&&e.script&&e.cond))return m();v(e.script,g,a.url,k).done(function(){var b={};Object.keys(f).forEach(function(a){b[a]=function(w){var E=arguments;c||(q?l.push(function(){b[a].apply(this,E)}):function(){return w&&w.finalUrl&&h!==w.finalUrl?(q=!0,v(e.script,g,w.finalUrl,k).fail(function(){c||
(d&&d.abort(),c=!0,m("Request was redirected to a not whitelisted URL",w.finalUrl),n.warn("cor: request to",h,"was redirect to a not whitelisted URL",w.finalUrl))}).always(function(){h=w.finalUrl;q=!1;l.length&&window.setTimeout(z,1)})):{always:function(a){a()}}}().always(function(){if(!c)f[a]({response:w})}))}});d=ia(a,b)}).fail(function(a){m(a);n.warn("cor: access to",h,"was denied")});return{abort:function(){c=!0;d&&d.abort()}}}}}(),ma=function(){var e=function(a){var b=[];a=new DataView(a);for(var f=
0;f<a.byteLength;f+=4){var d=("00000000"+a.getUint32(f).toString(16)).slice(-8);b.push(d)}return b.join("")},c={md5:function(a,b){return m.Pledge(H.MD5(a,b))}},h={};["SHA-1","SHA-256","SHA-384","SHA-512"].forEach(function(a){var b=a.toLowerCase().replace("-","");h[b]=function(){var b=function(b,g){var f=m();window.crypto.subtle.digest(a,H.str2arrbuf(b,g)).then(function(a){f.resolve(e(a))},function(){f.reject()});return f.promise()};try{return b("").then(function(a){if(a&&a.substr(0,4).toLowerCase().match(/[0-9a-f]{4,4}/))return b})}catch(g){return m.Breach()}}});
var l=function(a){return-1!=Object.keys(c).indexOf(a)},d=function(a){return function(){if(!1!==b){var g=arguments,f=m();b.push(function(){f.consume(a.apply(this,g))});return f.promise()}return a.apply(this,arguments)}},b=[];return{init:function(){n.D&&Object.keys(c).forEach(function(a){n.debug("sri:",a,"is supported")});return m.sidebyside(Object.keys(h).map(function(a){return h[a]().done(function(b){n.debug("sri:",a,"is supported");c[a]=b}).fail(function(){n.debug("sri:",a,"is unsupported")})})).always(function(){b.forEach(function(a){a()});
b=!1})},isSupported:d(function(a){return m.Pledge(l(a))}),getHash:d(function(a,b){var f=m();"string"===typeof a&&(a=B.parse(a));if(a&&a.hash){for(var d,c,h=a.hash.replace(/^#/,"").split(/,|;/g),k=0;k<h.length;k++)if((c=h[k].match(/([^=|:|-]+)[=|:|-](.+)/))&&3==c.length&&l(c[1])){d=c[2];if(!/^[0-9a-fA-F]+$/.exec(d)){var E;var n=decodeURIComponent(d);try{E=e(H.str2arrbuf(H.Base64.decode(n)))}catch(x){E=null}d=E||d}d={type:c[1],value:d}}f.resolve(d||(b?d:{type:"unsupported",value:""}))}else f.resolve();
return f.promise()}),check:d(function(a,b,f){return b&&a&&l(a.type)?c[a.type](b,f).then(function(b,g){return((g=b===a.value)?m.Pledge:m.Breach)(g||{type:a.type,value:b})}):m.Breach()})}}(),O=function(){var c={key:function(a,b){return p.CONSTANTS.PREFIX.EXTERNAL+u.select([a,b?H.MD5(b):null],function(a){return a}).join(":")},list:function(a){var b=new RegExp("^"+a);return u.select(r.listValues(),function(a){return-1!=a.search(b)})},set:function(a,b,f){a=c.key(a,b);var d={};u.each(f,function(a,b){"content"==
b&&(b="base",a=H.encodeS(a));d[b]=a});r.setValue(a,{ts:Date.now(),url:b,resource:d})},get:function(a,b){var f=c.key(a,b),f=r.getValue(f),d;if(f&&f.resource){var h={};u.each(f.resource,function(a,b){"base"==b&&(b="content",a=H.decodeS(a));h[b]=a});d={ts:f.ts,url:f.url,data:h}}return d},clean:function(a,b){var f=c.key(a,b);r.deleteValue(f)},cleanAll:function(a,b){var f,d=c.list(c.key(a));if(b){var h={};u.each(b,function(b){b=c.key(a,b);h[b]=!0});f=[];u.each(d,function(a){h[a]||f.push(a)})}else f=d;
f.forEach(function(a){r.deleteValue(a)})}},x=function(a,b){var f=m(),d={method:"GET",url:a,retries:p.XMLHTTPREQUEST.RETRIES,nocache:!1,responseType:b.via_arraybuffer?"arraybuffer":void 0},c=function(d){var c={content:""};if(4!=d.readyState||200!=d.status&&0!=d.status||d.error)f.reject(c);else{for(var e,q=d.responseHeaders?d.responseHeaders.split("\n"):[],h=0;h<q.length;h++){var l=q[h].split(":"),k=l.shift()||"",l=l.join(":")||"";if("content-type"==k.trim().toLowerCase()&&-1!=l.search("image")){e=
l.trim();break}}if(!e){var z;a.match(".*.(ico|jpg|jpeg)+($|\\?|#).*")?e="image/x-icon":(z=a.match(".*.(gif|png)+($|\\?|#).*"))?e="image/"+z[1]:-1!=a.search(".js")?e="text/javascript":(z=a.match(".*.(css|html|xml)+($|\\?|#).*"))?e="text/"+z[1]:u.isLocalImage(a)&&(e="image/x-icon")}c.meta=e;c.content=b.via_arraybuffer?H.arrbuf2str(d.response,b.encoding):d.responseText;f.resolve(c)}},e=function(){f.reject({})};b.sync?c(T(d,{})):(d.timeout=k.values.require_timeout,T(d,{onload:c,onerror:e,ontimeout:e}));
return f.promise()},h=u.getDebouncer(9E3),l=function(a,b,f){f.no_storage=!0;d(a,b,f).done(function(f){c.set(a,b,f.resource)}).fail(function(f){n.warn("externals: update.failed :(",a,b,f)}).always(function(){var f=c.get(a,b);f&&f.data?c.set(a,b,f.data):n.warn("externals: should never happen!")})},d=function(a,b,f){var d=m(),z=B.parse(b),v={sync:f.sync},w;ma.getHash(z,"supported"==k.values.require_sri_mode).done(function(m){if(b)if(R.getEvilnessOf(b)>=k.values.script_blacklist_severity)v.resource={blacklisted:!0,
content:""},d.reject(v);else if("enforce"!=k.values.require_sri_mode||m)if(!f.no_storage&&"file:"!==z.protocol&&(w=c.get(a,b))){var P=c.key(a,b),K=Date.now();0<k.values.external_update_interval&&K-w.ts>k.values.external_update_interval&&!h.is(P)&&(1<k.values.external_update_interval&&h.add(P),n.debug("externals: resource needs update",b,(new Date(w.ts)).toISOString(),(new Date(K)).toISOString()),window.setTimeout(function(){l(a,b,f)},3E3));v.resource=w.data;v.resource.forbidden||v.resource.blacklisted?
d.reject(v):d.resolve(v)}else v.sync=!1,"file:"==z.protocol&&-1==b.search(p.REQUESTS.GET_INTERNAL_PATH_REGEXP(!0))?(p.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||n.warn("externals: Access to local files is forbidden! Loading the following @resource may fail:",b,"-> more info:","http://tampermonkey.net/faq.php#Q204"),P=va.getSource({url:b,encoding:f.encoding})):P=x(b,{via_arraybuffer:f.via_arraybuffer,encoding:f.encoding}),P.done(function(h){m&&(h.sri=m);var l=function(d){!f.no_storage&&z.protocol&&"file:"!==
z.protocol&&-1==b.search(p.REQUESTS.GET_INTERNAL_PATH_REGEXP(!0))&&c.set(a,b,d)};m&&-1!=["supported","given"].indexOf(k.values.require_sri_mode)?ma.check(m,h.content,f.encoding).done(function(){v.resource=h;l(v.resource);d.resolve(v)}).fail(function(a){v.resource={forbidden:!0,sri:{mode:k.values.require_sri_mode,type:m.type,value:"invalid"},determined:a,content:""};l(v.resource);d.reject(v)}):(v.resource=h,l(v.resource),d.resolve(v))}).fail(function(f){n.debug("externals: get.failed",a,b,f);v.resource=
{failed:!0,content:""};d.reject(v)});else v.resource={forbidden:!0,sri:{mode:k.values.require_sri_mode},content:""},d.reject(v);else v.resource={forbidden:!0,content:""},d.reject(v)});return d.promise()},b={getElement:function(a,b){return c.get(a,b)},cleanElement:function(a,b){return c.clean(a,b)},dropAll:function(a){c.cleanAll(a);return m.Pledge()},dropAllBut:function(a,b){c.cleanAll(a,b);return m.Pledge()},loadResources:function(a,d){var f=m();b.getResources(a,d).always(function(){f.resolve()});
return f.promise()},loadRequires:function(a,d){var f=m();b.getRequires(a,d).always(function(){f.resolve()});return f.promise()},getResources:function(a,b){var f={elements:[]},c=m(),e=[],h={via_arraybuffer:!0,sync:!0};b.forEach(function(b){var g=b.url||B.sanitize(b.unsafe_url,b.abs_url),c={name:b.name,url:g},g=d(a,g,h),q=m();g.done(function(a){a=a.resource;c.content=a.content;c.meta=a.meta||"application"}).fail(function(a){a.resource&&a.resource.forbidden?a.resource.sri?n.warn("externals: can't load @resource",
b.name,"from URL",b.unsafe_url,"due to a SRI error"):n.warn("externals: can't load @resource",b.name,"from forbidden URL",b.unsafe_url):a.resource&&a.resource.blacklisted?n.warn("externals: can't load @resource",b.name,"from blacklisted URL",b.unsafe_url):(n.warn("externals: can't load @resource",b.name,"from URL",b.unsafe_url),c.failed=!0);c.content=null}).always(function(a){h.sync&=a.sync;f.elements.push(c);q.resolve()});e.push(q)});m.when(e).always(function(){f.sync=h.sync;c.resolve(f)});return c.promise()},
getRequires:function(a,b){var f={elements:[]},c=m(),e=[],h={encoding:"UTF-8",sync:!0};u.each(b,function(b,g){var c=b.url||B.sanitize(b.unsafe_url,b.abs_url),q={},c=d(a,c,h),l=m();c.done(function(a){q.textContent=a.resource.content||""}).fail(function(a){a.resource&&a.resource.forbidden?a.resource.sri?(q.textContent="// this @require's (\""+encodeURIComponent(b.unsafe_url)+'") SRI check failed!\n',n.warn("externals: can't load @require from URL",b.unsafe_url,"due to a SRI error")):(q.textContent='// this @require ("'+
encodeURIComponent(b.unsafe_url)+'") is not allowed!\n',n.warn("externals: can't load @require from forbidden URL",b.unsafe_url)):a.resource&&a.resource.blacklisted?(q.textContent='// this @require ("'+encodeURIComponent(b.unsafe_url)+'") is blacklisted!\n',n.warn("externals: can't load @require from blacklisted URL",b.unsafe_url)):(q.textContent='// this @require ("'+encodeURIComponent(b.unsafe_url)+'") could not be loaded!\n',n.warn("externals: can't load @require from URL",b.unsafe_url))}).always(function(a){h.sync&=
a.sync;f.elements[g]=q;l.resolve()});e.push(l)});m.when(e).always(function(){f.sync=h.sync;f.elements=f.elements.filter(function(a){return a});c.resolve(f)});return c.promise()}};return b}();exts=O;var ua=function(){var c=function(c,e,d){var b=m(),a=[];d.forEach(function(b){b=b.textContent||"";b=ja.mkCompat(b,c.options.compatopts_for_requires?c:null,"off"!=k.values.runtime_strict_mode);a.push(b)});d="\n"+a.join("\n")+"\n";var g=A.getStorageByUid(c.uuid);e=ja.mkCompat(e,c,"off"!=k.values.runtime_strict_mode);
if(k.values.debug){e=e.split("\n");for(var f=!1,q,z=0;z<e.length;z++)if(q=e[z],!q.match(/^\s*$|^\s*\/\/\s*|^\s*\/\*.*\*\/\s*$|^\s*["']+use strict["']+;*\s*$/))if(q.match(/^\s*\/\*/)&&(f=!0),f)if(q.match(/\*\/\s*$/))f=!1;else{if(-1!=(q=q.search(/\*\//))){e[z]=u.insert(e[z],q+2,0,"debugger;");break}}else{e[z]="debugger;"+e[z];break}e=e.join("\n")}b.resolve({header:c.header,code:e,requires:d,storage:g,script:c});return b.promise()},x={};return{bundle:function(h,l){var d,b,a=!0;if(d=x[l.uuid])return d;
var g={},f="includes matches requires resources excludes connects textContent".split(" ");Object.keys(l).forEach(function(a){-1==f.indexOf(a)&&("options"==a?(g[a]=JSON.parse(JSON.stringify(l[a])),g[a].run_at=g[a].run_at||l.options.override.orig_run_at||"document-idle"):g[a]=l[a])});d=O.getResources(g.uuid,l.resources).then(function(b){a&&!b.sync&&(n.debug("ri: uncached @external detected -> fast script start disabled"),a=b.sync);g.resources=b.elements;return O.getRequires(g.uuid,l.requires)}).then(function(b){a&&
!b.sync&&(n.debug("ri: uncached @external detected -> fast script start disabled"),a=b.sync);b=b.elements;n.debug("run script "+g.name+" @ "+h.url);return c(g,l.textContent,b)}).always(function(){b=!0;delete x[g.uuid]});b||(x[g.uuid]=d);return d}}}(),xa=function(){var c=rea.extension.getViews({type:"popup"});c&&c.length&&rea.extension.sendMessage({method:"updateActions"},function(){})},Y=function(){return{getConfig:function(){var c={version:0,last:0},k={scripts:0},h=r.getValue(p.CONSTANTS.STORAGE.UPDATE,
k);"object"!==typeof h&&(h=k);h||(h=k);void 0==h.black&&(h.black=c);void 0==h.scripts&&(h.scripts=0);return h},setConfig:function(c){c&&r.setValue(p.CONSTANTS.STORAGE.UPDATE,c)}}}(),Z=function(){var e=function(e,d){var b=0,a=0;if(e){var g=c.getMessage("Script_Update"),f=c.getMessage("Check_for_userscripts_updates")+"...";Q.show(g,f,rea.extension.getURL("images/icon128.png"),1E4)}g=A.getUidList().map(function(f){var g,e,l,E,x,r;n.info("update: check for script updates @",f);return function(){E=A.getByUid(f);
if(!E.script||!E.cond)return n.warn("update: inconsistent script entry",f,E),m.Breach();var a=!k.values.scriptUpdateCheckDisabled&&!E.script.enabled&&!d;return d&&E.script.uuid!==d||a||!(r=t.determineSourceURL(E.script))?m.Breach():m.Pledge()}().then(function(){var a=t.determineMetaURL(E.script);if(!a)return m.Pledge();var b=m();ia({method:"GET",retries:p.XMLHTTPREQUEST.RETRIES,timeout:1E3*p.SCRIPT_DOWNLOAD.TIMEOUT,nocache:!0,headers:{Accept:"text/x-userscript-meta, */*"},url:a},{ondone:function(f){4==
f.readyState&&200==f.status?x=y.processMetaHeader(f.responseText):n.warn("update: unable to find meta data @ "+a+" req.status = "+f.status);b.resolve()}});return b.promise()}).then(function(){var a=!!x,b=a&&!!x.version,f=b&&(!E.script.version||y.versionCmp(x.version,E.script.version)==y.versionCmp.eNEWER);return a&&b&&!f?m.Breach():m.Pledge()}).then(function(){return h.getScriptFromURL(r).fail(function(){n.warn("update: failed",E.script.name,r)})}).then(function(a){var f;var d=E.script.uuid;f=y.createScriptFromSrc(a);
f=f.name&&""!=f.name&&void 0!==f.version?(d=A.getMetaByUid(d))&&d.system?null:f.options.compat_uW_gmonkey?y.versionCmp.eERROR:-1!=f.name.search("@")?y.versionCmp.eERROR:d&&f.version==d.version?y.versionCmp.eEQUAL:d&&y.versionCmp(f.version,d.version)==y.versionCmp.eOLDER?y.versionCmp.eOLDER:y.versionCmp.eNEWER:y.versionCmp.eERROR;return f==y.versionCmp.eNEWER?(b++,g=E.script.name,e=r,l=a,m.Pledge()):m.Breach()}).then(function(){if(k.values.notification_silentScriptUpdate)return m.Pledge();var a=c.getMessage("There_is_an_update_for_0name0_avaiable_",
g)+"\n"+c.getMessage("Click_here_to_install_it_"),b=c.getMessage("Just_another_service_provided_by_your_friendly_script_updater_")+":",f=m();Q.show(b,a,rea.extension.getURL("images/icon128.png"),k.values.scriptUpdateHideNotificationAfter,f.resolve);return f.promise()}).then(function(b){var d=f||E.script.uuid;return void 0===b||b.clicked?t.doSave({url:e,uuid:d,replace:!d,src:l,ask:!k.values.notification_silentScriptUpdate}).done(function(b){b&&b.installed&&a++}):m.Breach()})});return m.sidebyside(g).then(function(){0==
b&&e&&(n.debug("No update found"),Q.show("Narf!",c.getMessage("No_update_found__sry_"),rea.extension.getURL("images/icon128.png"),1E4));return{found:b,installed:a}})},x=null,h={check:function(h,d,b){if(!h&&0>=k.values.scriptUpdateCheckPeriod)return m.Breach();var a=Y.getConfig();if(!h&&Date.now()-a.scripts<Math.max(k.values.scriptUpdateCheckPeriod,36E5))return m.Breach();var g=m();h=function(){f&&(window.clearTimeout(f),f=null);q&&q.cancel();e(d,b).done(function(a){g.resolve(a.installed)}).fail(function(){g.resolve(null)});
a=Y.getConfig();a.scripts=Date.now();Y.setConfig(a)};var f,q,z=function(){q=null;var a=c.getMessage("Script_Update"),b=c.getMessage("Waiting_for_sync_to_finish")+"...";q=Q.show(a,b,rea.extension.getURL("images/icon128.png"),6E4)};G.enabled?(G.addSyncDoneCallback(h),G.sync(50,!1),d&&(f=window.setTimeout(z,500))):h();return g.promise()},getScriptFromURL:function(c){var d=m();T({method:"GET",retries:p.XMLHTTPREQUEST.RETRIES,timeout:1E3*p.SCRIPT_DOWNLOAD.TIMEOUT,nocache:!0,headers:{Accept:"text/x-userscript, */*"},
url:c},{onload:function(b){4!=b.readyState||200!=b.status&&0!=b.status||b.error?d.reject():d.resolve(b.responseText)},onerror:function(b){d.reject({error:!0,responseText:b.responseText})},ontimeout:function(){d.reject({timeout:!0,responseText:""})}});return d.promise()},init:function(){var c=function(){x&&(window.clearTimeout(x),x=null);0<k.values.scriptUpdateCheckPeriod&&(x=window.setTimeout(function(){x=null;h.check();c()},36E5))};c();k.addChangeListener("scriptUpdateCheckPeriod",c)}};return h}();
trup=Z;var t=function(){var e=function(b){b.sort(function(a,b){return a.position-b.position});return b},x=function(b){void 0===b.ask&&(b.ask=!0);if(void 0===b.url||null==b.url)b.url="";""===b.force_url&&(b.force_url=null);var a=y.createScriptFromSrc(b.src),g=null,f={heading:null,errors:[],info:[],warnings:[],flags:{}},e=m(),h=Date.now(),l=b.save&&!b.ask&&k.values.editor_easySave,w=b.uuid,E;a.name&&void 0!=a.version?E=m.Pledge():(f.errors.push(c.getMessage("Invalid_UserScript__Sry_")+"\n\n"),b.name&&
f.errors.push(c.getMessage("Script_name_0name0",b.name)+"\n\n"),b.url&&f.errors.push(c.getMessage("Downloaded_from_0url0",b.url)),n.warn("scriptman: invalid userscript",f,a),E=m.Breach());E.then(function(){b.replace&&!w&&(w=A.getUidsByName(a.name,a.namespace)[0]);if(w)g=A.getMetaByUid(w);else if(a.uuid)w=a.uuid;else if(b.replace)w=u.createUUID();else return n.warn("scriptman: neither UUID, @uuid nor replace option set"),m.Breach();if(""!==w.replace(/[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}/,
""))return n.warn("scriptman: invalid UUID",w),m.Breach();if(!b.clean&&!b.defaultscript&&g&&g.system)return m.Breach()}).then(function(){if(b.clean&&b.name&&b.name!=a.name||-1!=a.name.search("\n"))return f.errors.push(c.getMessage("Invalid_UserScript_name__Sry_")),m.Breach()}).then(function(){if(a.options.compat_uW_gmonkey)return f.errors.push(c.getMessage("This_script_uses_uW_gm_api_")),m.Breach()}).then(function(){if(g){g.name!=a.name&&(f.flags.renamed=!0);if(g.lastModified&&void 0!==b.lastModified&&
g.lastModified!==b.lastModified){var d=c.getMessage("some_secs");try{var e=Math.max(1,Math.floor((h-g.lastModified)/1E3));isNaN(e)||(d=e)}catch(q){}f.warnings.push(c.getMessage("CONFLICT__This_script_was_modified_0t0_seconds_ago_",d));f.flags.forceAsk=!0}a.version==g.version&&(b.save?f.flags.modification=!0:f.flags.reset=!0);b.clean&&(f.flags.factory=!0)}else f.flags.first_install=!0;a.includes.length||a.matches.length||l||b.internal||f.warnings.push(c.getMessage("This_script_does_not_provide_any__include_information_"));
f.flags.sync=!!b.sync;f.flags.internal=b.internal;f.flags.ask=b.ask}).then(function(){a.uuid=w;a.system=b.defaultscript;a.evilness=t.getEvilness(a);a.position=t.determineLastPosition()+1;a.lastUpdated=b.force_meta&&b.force_meta.lastUpdated||h;f.flags.factory||f.flags.reset?g&&(a.lastUpdated=g.lastUpdated):(b.force_url&&(a.updateURL=null,a.downloadURL=b.force_url),g&&(a.options.override=g.options.override,a.options.comment=g.options.comment));["includes","excludes","matches","connects"].forEach(function(b){a.options.override["orig_"+
b]=a[b]});a.options.override.orig_noframes=a.options.noframes;a.options.override.orig_run_at=a.options.run_at||"document-idle";a.options.noframes=null;a.options.run_at=null}).then(function(){if(g&&(a.fileURL=g.fileURL,a.position=g.position,g.sync&&(a.sync=g.sync),!f.flags.factory&&!f.flags.reset)){a.enabled=g.enabled;a.options.noframes=g.options.noframes;a.options.run_at=g.options.run_at;a.options.awareOfChrome||(a.options.compat_forvarin=g.options.compat_forvarin);b.save&&!b.force_url&&(a.downloadURL=
g.downloadURL||a.downloadURL);var e=d.determineMetaURL(g),h=d.determineMetaURL(a),e=e?B.woHash(e):e,h=h?B.woHash(h):h;e==h||l||b.internal||f.warnings.push(c.getMessage("The_update_url_has_changed_from_0oldurl0_to__0newurl0",[e,h]))}}).then(function(){if(g&&!f.flags.factory&&a.version==g.version&&(b.defaultscript||b.noreinstall))return m.Breach()}).then(function(){g?(f.flags.factory||f.flags.reset?(f.flags.reset?(f.heading=c.getMessage("You_are_about_to_reinstall_a_UserScript_"),f.flags.reinstall=
!0):(f.heading=c.getMessage("You_are_about_to_install_a_UserScript_"),f.flags.install=!0),b.internal||f.warnings.splice(0,0,c.getMessage("All_script_settings_will_be_reset_"))):f.flags.modification?f.heading=c.getMessage("You_are_about_to_modify_a_UserScript_"):y.versionCmp(a.version,g.version)==y.versionCmp.eOLDER?(f.heading=c.getMessage("You_are_about_to_downgrade_a_UserScript"),f.flags.downgrade=!0,l||b.internal||f.warnings.splice(0,0,c.getMessage("The_downgraded_script_might_have_problems_to_read_its_stored_data_"))):
(f.heading=c.getMessage("You_are_about_to_update_a_UserScript_"),f.flags.update=!0),f.info.push({label:c.getMessage("Installed_Version_"),value:"v"+g.version})):(f.heading=c.getMessage("You_are_about_to_install_a_UserScript_"),l||b.internal||(f.info.splice(0,0,c.getMessage("Malicious_scripts_can_violate_your_privacy_")),R.getWarningsFor(d.determineSourceURL(a)).forEach(function(a){f.warnings.splice(0,0,a)})),f.flags.install=!0);f.flags.install?f.action=c.getMessage("Install"):f.flags.reinstall?f.action=
c.getMessage("Reinstall"):f.flags.modification?f.action=c.getMessage("Modify"):f.flags.downgrade?f.action=c.getMessage("Downgrade"):f.flags.update&&(f.action=c.getMessage("Update"))}).then(function(){b.url&&(a.fileURL=b.url);b.sync&&(a.sync=b.sync);b.force_options&&u.copy(b.force_options,a.options,(new y.Script).options,!0);b.force_settings&&u.copy(b.force_settings,a,["enabled","position"]);a=t.mergeCludes(a)}).then(function(){var b=!1,d;for(d in a.options)if(-1!=d.search("compat_")&&!0===a.options[d]){b=
!0;break}b&&f.info.push({label:c.getMessage("Note"),value:c.getMessage("A_recheck_of_the_GreaseMonkey_FF_compatibility_options_may_be_required_in_order_to_run_this_script_")})}).then(function(){["requires","resources"].forEach(function(b){a[b]=u.map(a[b],function(b){b.unsafe_url=b.url;b.abs_url=a.fileURL?a.fileURL.split("/").slice(0,-1).join("/"):null;b.url=null;return b})})}).done(function(){e.resolve({script:a,messages:f,short_info:[{label:c.getMessage("Author"),prop:"author"},{label:c.getMessage("Description"),
prop:"description"},{label:c.getMessage("Source"),prop:"fileURL"}]})}).fail(function(){e.reject({messages:f})});return e.promise()},h=function(b){var a=m(),g=b.messages,f=b.script,c=!g.flags.internal,e=function(){var a=d.doModify(f.uuid,f,c)||{};g.flags.modification||O.dropAll(f.uuid);(g.flags.first_install||g.flags.factory)&&A.setStorageByUid(f.uuid,{ts:Date.now()});return a},h={lastModified:void 0,installed:!0,renamed:g.flags.renamed};g.warnings.length||g.flags.ask?ca.install(b).done(function(b){b.ok&&
e();h.installed=b.ok;h.aborted=b.aborted;a.resolve(h)}).fail(function(b){a.reject(b)}):(e(),a.resolve(h));return a.promise()},l=u.getDebouncer(1E3),d={determineSourceURL:function(b){return b?u.select([b.downloadURL,b.fileURL],function(a){if(!a||"file:"!==B.parse(a).protocol)return a})[0]:null},determineMetaURL:function(b){if(!b)return null;var a,d=t.determineOrigin(b);d&&d.meta_header?a=b.fileURL:!b.fileURL||d&&!d.meta_url||(a=b.fileURL.replace(".user.js",".meta.js"),b.fileURL==a&&(a=b.fileURL.replace(".tamper.js",
".meta.js")),b.fileURL==a&&(a=null));return u.select([b.updateURL,b.downloadURL,a],function(a){if(!a||"file:"!==B.parse(a).protocol)return a})[0]},mergeCludes:function(b){var a,d,f=b.options.override;["includes","excludes","matches"].forEach(function(a){b[a]=f["merge_"+a]&&f["orig_"+a]?f["orig_"+a].slice():[]});if(f.use_includes)for(a=0;a<f.use_includes.length;a++)d=b.excludes.indexOf(f.use_includes[a]),0<=d&&b.excludes.splice(d,1),b.includes.push(f.use_includes[a]);if(f.use_matches)for(a=0;a<f.use_matches.length;a++)d=
b.excludes.indexOf(f.use_matches[a]),0<=d&&b.excludes.splice(d,1),b.matches.push(f.use_matches[a]);if(f.use_excludes)for(a=0;a<f.use_excludes.length;a++)b.excludes.push(f.use_excludes[a]);return b},doSave:function(b){return x(b).then(h)},doRemove:function(b,a){A.removeByUid(b,a);A.setStorageByUid(b,null);O.dropAll(b);return m.Pledge()},doModify:function(b,a,d){void 0===d&&(d=!0);A.setByUid(b,a,d);return d?O.loadResources(b,a.resources).then(function(){return O.loadRequires(b,a.requires)}).then(function(){var d=
[].concat(a.resources).concat(a.requires).map(function(a){return B.sanitize(a.unsafe_url,a.abs_url)});return O.dropAllBut(b,d)}):m.Pledge()},exportToJson:function(b,a){var d=m(),f=t.determineScriptsToRun(null);b&&(f=u.select(f,function(a){return b[a.uuid]}));f=na(f,!0);a&&!a.storage||f.forEach(function(a){a.storage=A.getStorageByUid(a.uuid)});f={scripts:f};if(!a||a.global_settings)f.global_settings=r.getValue(p.CONSTANTS.STORAGE.CONFIG,{});d.resolve(f);return d.promise()},importFromJson:function(b){if(!b||
!b.scripts||!b.scripts.length)return m.Breach();for(var a={},d=[],f={},c=0,e;e=b.scripts[c];c++)try{var l=m();"new-user-script"!=e.uuid&&(e.storage&&(f[e.uuid]=e.storage),x({uuid:e.uuid,name:e.name,src:e.source,force_settings:{enabled:e.enabled,position:e.position},force_options:e.options,force_meta:{lastUpdated:e.lastModified},replace:!0,url:e.file_url||e.update_url,ask:!1}).done(function(b){a[u.createUUID()]=b;l.resolve()}).fail(function(a){n.warn("import: Error @ script",e.name,a);l.resolve()}),
d.push(l.promise()))}catch(k){n.warn("import: Error while importing script",e.name,k)}var w=function(){var a=m();m.when(d).always(function(){a.resolve()});return a.promise()}().then(function(){return ca.import(a,b.global_settings)}).then(function(b){var d=m(),g=[],c=[];if(b.ok)for(var e=0,l;l=b.import_ids[e];e++)(function(){var b=l;if(a[b]){a[b].messages.warnings=[];var d=h(a[b]).done(function(){var d;(d=a[b].script.uuid)&&f[d]&&(d=A.setStorageByUid(d,{data:f[d].data||{},ts:Date.now()}),c.push(d))});
g.push(d)}})();m.when(g).always(function(){t.reorderScripts();m.when(c).always(function(){d.resolve(b)})});return d.promise()}).then(function(a){return b.global_settings&&a.global_settings?(a=r.setValue(p.CONSTANTS.STORAGE.CONFIG,b.global_settings).then(function(){w.done(function(){window.setTimeout(U.reset,1)});return m.Pledge({global_settings:!0})}),r.setTemporary(!0),a):m.Pledge({})});return w},installFromUrl:function(b,a,g){var f=m(),e=B.parse(b),h={messages:{errors:[c.getMessage("Unable_to_load_script_from_url_0url0",
b)],warnings:[]}};a=a||{};g=g||{};var k=["url",b,JSON.stringify(a)].join("_");if(l.is(k))return n.debug("scriptman: de-bounced installFromUrl",b),m.Breach();l.add(k);if(!e.protocol.match(/(https?|file):/))return n.warn("scriptman: can't install from ",b),m.Breach(h);"file:"!=e.protocol||p.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||n.warn("scriptman: Access to local files is forbidden! Loading the following script for installation may fail:",b,"-> more info:","http://tampermonkey.net/faq.php#Q204");var w=
function(a,b){if(!a)if(b)a=h,"file:"!=e.protocol||p.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||a.messages.warnings.unshift(c.getMessage("Tampermonkey_has_no_file_access_permission_"));else{f.reject();return}a.heading=c.getMessage("You_are_about_to_install_a_UserScript_");g.silent_fail?f.reject(a):ca.installError(a).always(function(a){f.reject(a)})};Z.getScriptFromURL(b).done(function(g){var c={url:b,src:g,ask:!0,replace:!0};a&&u.each(a,function(b,d){c[d]=a[d]});d.doSave(c).done(function(a){f.resolve(a.installed)}).fail(w)}).fail(function(a){w(null,
a)});return f.promise()},determineLastPosition:function(){var b=0;A.getUidList().forEach(function(a){var d=A.getByUid(a);d.script&&d.cond?d.script.position&&d.script.position>b&&(b=d.script.position):n.warn("scriptman: inconsistent script entry",a)});var a=new y.Script;a.position>b&&(b=a.position);return b},convertToRegExp:function(b,a){var d,f;try{!a&&1<b.length&&"/"==b.substr(0,1)?d=new RegExp(".*"+b.replace(/^\//g,"").replace(/\/$/g,"")+".*","i"):a?(f=B.getRegExpFromMatch(b),d=new RegExp(f)):(f=
B.getRegExpFromInclude(b),d=new RegExp(f,"i"))}catch(c){return n.warn("scriptman: invalid regexp ",b),!1}return d},matchUrl:function(b,a){return""===b.replace(a,"")},regexify:function(b,a){var g={},f={inc:"rinc",match:"rinc",exc:"rexc"};Object.keys(f).forEach(function(c){var e=b[c]&&b[c].length?b[c].map(function(a){return d.convertToRegExp(a,"match"===c)}).filter(function(a){return!1!==a}):null;if(e||a)g[f[c]]=(g[f[c]]||[]).concat(e||[])});return g},validUrl:function(b,a,g){var f=!1;if(a.rinc){if(a.rinc.every(function(a){return d.matchUrl(b,
a)?(n.debug('scriptman: @include "'+a+'" matched'+(g?" ("+g+")":'"')),f=!0,!1):!0}),!f)return f}else f=!0;a.rexc&&a.rexc.every(function(a){return d.matchUrl(b,a)?(n.debug('scriptman: @exclude "'+a+'" matched'+(g?" ("+g+")":'"')),f=!1):!0});return f},getEvilness:function(b){var a=0;return b.fileURL&&(a=R.getEvilnessOf(b.fileURL))||b.downloadURL&&(a=R.getEvilnessOf(b.downloadURL))||b.updateURL&&(a=R.getEvilnessOf(b.updateURL))?(n.debug("scriptman: found blacklisted script",b),a):0},blackCheckAll:function(){A.getUidList().forEach(function(b){var a=
A.getByUid(b);if(a.script&&a.cond){var g=t.getEvilness(a.script);if(g!==a.script.evilness){if(g||void 0!==a.script.evilness)n.debug("scriptman: write blacklist state of ",a.script.name,g),g&&L.tS(a.script.name,g,"b");a.script.evilness=g;d.doModify(b,a.script,!1)}}})},reorderScripts:function(b,a){var g=d.determineScriptsToRun();if(b)for(var f=0;f<g.length;f++){var c=g[f];c.uuid==b&&(c.position=Number(a)+(c.position<a?.5:-.5))}g=e(g);f=1;for(c=0;c<g.length;c++){var h=g[c];h.position=f++;d.doModify(h.uuid,
h,!1)}},getUniqueScriptsForTab:function(b){var a=[];C.get.empty(b.id)?n.debug("bg: WARN: Tabs.get.urls["+b.id+"] is empty!"):u.each(C.get.urls(b.id),function(b,d){if(X.isAllowed(d))for(var c=t.determineScriptsToRun(d),e=0;e<c.length&&(0===b.frameId||!0!==c[e].options.noframes&&(null!==c[e].options.noframes||!0!==c[e].options.override.orig_noframes));e++){for(var h=!1,l=0;l<a.length;l++)if(a[l].uuid==c[e].uuid){h=!0;break}h||a.push(c[e])}});return a},determineScriptsToRun:function(b){var a=[];n.debug("scriptman: determineScriptsToRun @"+
b);A.getUidList().forEach(function(g){if(b){var f=J.items.regexp.get(g);if(!f){if(!(f=r.getValue(p.CONSTANTS.PREFIX.COND+g,null)))return;f=d.regexify(f,!0);J.items.regexp.set(g,f)}if(!d.validUrl(b,f,g))return}f=A.getByUid(g);f.script&&f.cond?a.push(f.script):n.warn("scriptman: inconsistent script entry",g,f)});return e(a)},isContexter:function(b){return b.options&&("context-menu"===b.options.run_at||null===b.options.run_at&&"context-menu"===b.options.override.orig_run_at)},determineOrigin:function(b){return d.determineOriginOfUrl(b.fileURL||
b.downloadURL||b.updateURL)},determineOriginOfUrl:function(b){if(b){var a=b.match(/https?:\/\/userscripts\.org\/scripts\/(source|version)\/([0-9]{1,9})\.user\.js/)||b.match(/https?:\/\/userscripts-mirror\.org\/scripts\/(source|version)\/([0-9]{1,9})\.user\.js/);if(a&&3==a.length)return{id:a[2],token:"uso",meta_url:!0,url:"http://userscripts-mirror.org/scripts/show/"+a[2],issue_url:"http://contactbyweb.com/userscripts-mirror"};if((a=b.match(/https?:\/\/greasyfork\.org\/scripts\/([^/]+)\/code\/.*\.user\.js/))&&
2==a.length)return{id:a[1],token:"gf",meta_url:!0,url:"https://greasyfork.org/scripts/"+a[1],issue_url:"https://greasyfork.org/scripts/"+a[1]+"/feedback"};if((a=b.match(/https?:\/\/openuserjs\.org\/install\/([^/]+)+\/(.*)\.user\.js/))&&3==a.length)return a.shift(),{id:a.join("/"),token:"ouj",meta_header:!0,url:"https://openuserjs.org/scripts/"+a[0]+"/"+a[1],issue_url:"https://openuserjs.org/scripts/"+a[0]+"/"+a[1]+"/issues"};if((a=b.match(/https?:\/\/monkeyguts\.com\/(codepages\/)?([0-9]{1,9})\.user\.js/))&&
3==a.length)return{id:a[2],token:"mog",meta_url:!0,url:"https://monkeyguts.com/code.php?id="+a[2],issue_url:"https://monkeyguts.com/code.php?nav=rev&id="+a[2]};if((b=b.match(/https?:\/\/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)\/.*\.user\.js/)||b.match(/https?:\/\/github\.com\/([^/]+)\/([^/]+)\/raw\/.*\.user\.js/)||b.match(/https?:\/\/github\.com\/([^/]+)\/([^/]+)\/releases\/download\/.*\.user\.js/))&&3==b.length)return b.shift(),{id:b.join("/"),token:"gh",url:"https://github.com/"+b.join("/"),
issue_url:"https://github.com/"+b.join("/")+"/issues"}}}};return d}(),A=function(){var c=[],m={init:function(){r.addDifferentOriginChangeListener(p.CONSTANTS.PREFIX.STORE,function(c,e){if(e&&e.hasOwnProperty("value")&&e.origin){var d=c.replace(p.CONSTANTS.PREFIX.STORE,""),b;for(b in e.value.data)e.value.data.hasOwnProperty(b)&&function(){var a=b,g=e.value.data[b];m.notifyStorageListeners({uuid:d},null,function(b){var d={data:{},ts:0};d.data[a]=g;d.ts=e.value.data.ts;var c={storage:d};void 0===d.data[a]&&
(c.removed=a);b(c)})}()}})},getUidList:function(){var c=new RegExp("^"+p.CONSTANTS.PREFIX.SCRIPT_UID),e=[];r.listValues().forEach(function(d){-1!=d.search(c)&&e.push(d.replace(c,""))});return e},getUidsByName:function(c,e){var d=[];m.getUidList().forEach(function(b){var a=m.getMetaByUid(b);!a||a.name!=c||e&&e!=a.namespace||d.push(b)});return d},getUidByName:function(c){return m.getUidsByName(c)[0]},getStorageByUid:function(c){c=r.getValue(p.CONSTANTS.PREFIX.STORE+c,{ts:0,data:{}});"undefined"===typeof c.ts&&
(c.ts=0);"undefined"===typeof c.data&&(c.data={});return c},setStorageByUid:function(c,e){return e?r.setValue(p.CONSTANTS.PREFIX.STORE+c,e):r.deleteValue(p.CONSTANTS.PREFIX.STORE+c)},getMetaByUid:function(c){return r.getValue(p.CONSTANTS.PREFIX.META+c,null)},getByUid:function(c,e){if(!c)return n.error("sb: no UUID set"),{};var d,b=r.getValue(p.CONSTANTS.PREFIX.META+c,null);if(b){var a=function(a){if(a)for(var b=0,d=null;d=a[b];b++)delete d.loaded,delete d.textContent,delete d.resURL,delete d.resText};
a(b.requires);a(b.resources);b.uuid=c;b.grant=b.grant||[];b.options.override.use_connects||(b.connects=b.connects||[],b.options.override.merge_connects=!0,b.options.override.use_connects=[]);e&&(b=u.copy(b,{}));b.textContent=r.getValue(p.CONSTANTS.PREFIX.SCRIPT+c,b.textContent);b.textContent&&(d=b)}return{script:d,cond:r.getValue(p.CONSTANTS.PREFIX.COND+c,null)}},setByUid:function(c,e,d){var b={};if(!c)return n.error("sb: no UUID set",e),b;if(null===e.textContent||void 0===e.textContent)throw Error("No script code set!");
var a=r.getValue(p.CONSTANTS.PREFIX.META+c),g=!a;r.setValue(p.CONSTANTS.PREFIX.SCRIPT_UID+c,e.name);r.setValue(p.CONSTANTS.PREFIX.COND+c,{inc:e.includes,match:e.matches,exc:e.excludes});r.setValue(p.CONSTANTS.PREFIX.SCRIPT+c,e.textContent);var f=u.copy(e,{});f.textContent=null;d&&(b.lastModified=Date.now(),f.lastModified=b.lastModified);r.setValue(p.CONSTANTS.PREFIX.META+c,f);d&&(ha.onScriptsChanged(),g?G.scriptAddedCb(e.name,e):G.scriptChangedCb(e.name,e,a),k.values&&L.tS(e.name,e.fileURL,g?"i":
"u"));J.items.rundata.removeAll();J.items.regexp.remove(c);return b},removeByUid:function(c,e){void 0===e&&(e=!0);var d=m.getByUid(c);r.deleteValue(p.CONSTANTS.PREFIX.SCRIPT_UID+c);r.deleteValue(p.CONSTANTS.PREFIX.COND+c);r.deleteValue(p.CONSTANTS.PREFIX.SCRIPT+c);r.deleteValue(p.CONSTANTS.PREFIX.META+c);r.deleteValue(p.CONSTANTS.PREFIX.STORE+c);e&&(ha.onScriptsChanged(),d.script&&d.cond&&(G.scriptRemovedCb(d.script.name,d.script),k.values&&L.tS(d.script.name,null,"r")));J.items.rundata.removeAll();
J.items.regexp.remove(c);return{}},addStorageListener:function(h,l,d,b,a){c.push({tabid:h,id:l,uuid:d,time:b,response:a})},removeStorageListeners:function(h,l){void 0===l&&(l=!0);var d=c;c=[];d.forEach(function(b){try{void 0!==h.tabid&&h.tabid!==b.tabid||void 0!==h.uuid&&h.uuid!==b.uuid||void 0!==h.id&&h.id!==b.id?c.push(b):l&&b.response({})}catch(a){n.debug("sb: listener clear for script",h,"failed! Page reload?!")}})},notifyStorageListeners:function(h,l,d){h=h||{};l=l||{};c.forEach(function(b){try{void 0!==
l.uuid&&b.uuid===l.uuid||void 0!==l.tabid&&b.tabid===l.tabid||void 0!==l.id&&b.id===l.id||void 0!==h.tabid&&h.tabid!==b.tabid||void 0!==h.uuid&&h.uuid!==b.uuid||void 0!==h.id&&h.id!==b.id||d&&d(b.response)}catch(a){n.warn("sb: listener notification for script",h,"failed! Page reload?!")}})}};return m}();scbr=A;var ta=function(){var e={ping:{allow:{insecure:!0},exec:function(d,b,a){a({pong:!0,instanceID:sa,config:{layout:k.values.layout}})}},newTab:{allow:{extpage:!0},exec:function(d,b,a){rea.tabs.create({url:d.url},
function(b){a({tabId:b.id})})}},getTab:{allow:{script:!0},exec:function(d,b,a){b.tab&&d.uuid?(N[b.tab.id]||(N[b.tab.id]={}),N[b.tab.id][d.uuid]||(N[b.tab.id][d.uuid]={}),a({data:N[b.tab.id][d.uuid]})):(n.warn("bg: unable to process request",b,d),a({data:null}))}},getTabs:{allow:{script:!0},exec:function(d,b,a){if(d.uuid){var c={};Object.keys(N).forEach(function(a){c[a]={};c[a]=N[a][d.uuid]});a({data:c})}else n.warn("bg: unable to process request",b,d),a({data:null})}},setTab:{allow:{script:!0},exec:function(d,
b,a){if(b.tab&&d.uuid){N[b.tab.id]||(N[b.tab.id]={});var c={};d.tab&&Object.keys(d.tab).forEach(function(a){c[a]=d.tab[a]});N[b.tab.id][d.uuid]=c}else n.warn("bg: unable to process request",b,d);a({})}},focusTab:{allow:{script:!0},exec:function(d,b,a){(d=b&&b.tab?b.tab.id:null)?rea.tabs.update(d,{active:!0},function(){a({error:rea.runtime.lastError})}):a({error:"internal error"})}},closeTab:{allow:{script:!0},exec:function(d,b,a){var c=b&&b.tab?b.tab.id:null;c?rea.tabs.query({windowType:"normal"},
function(b){1>=b.length?(n.warn("bg:","refused to close last tab!"),a({error:"refused to close last tab!"})):rea.tabs.remove(c,function(){a({})})}):a({error:"internal error"})}},copyToClipboard:{allow:{script:!0,extpage:!0},exec:function(d,b,a){b.tab?oa.copy(d.data):n.warn("bg: unable to process request",b,d);a({})}},setOption:{allow:{extpage:!0},exec:function(d,b,a){b="options"==b.extpage||"options"==d.origin;k.values[d.name]=d.value;b?V.create("options.settings").done(function(b){a({items:b,options:k.snapshot})}).fail(function(b){a({error:b,
options:k.snapshot})}):a({})}},reportAnIssue:{allow:{extpage:!0},exec:function(d,b,a){var c,f,e;d.uuid&&(c=A.getByUid(d.uuid))&&c.script&&c.cond&&(b=t.determineOrigin(c.script),"author"==d.to&&c.script.supportURL?(f={url:c.script.supportURL},e=b?[d.to,b.token,b.id].join(":"):[d.to,f.url].join(":")):b&&(f=b,e=[f.token,f.id].join(":")),f&&(L.tS(c.script.name,e,"m"),rea.tabs.create({url:f.issue_url||f.url,active:!0},function(){})));a({})}},begEvent:{allow:{extpage:!0},exec:function(d,b,a){if("dialog"==
d.action)aa.dialog.shown(d.extra);else if("clicked"==d.action){var c,f;d.extra&&(c=d.extra.amount,f=d.extra.currency);aa.clicked(d.type,c,f)}else if(aa.button[d.action])aa.button[d.action](d.extra);else n.warn("bg: Warning: unknown request ",d);a({})}},buttonPress:{allow:{extpage:!0},exec:function(d,b,a){var c=function(){a({})};if("reset_simple"==d.name)U.reset(c);else if("reset_factory"==d.name)U.factoryReset(c);else if("create_tesla_data"==d.name)G.createTeslaData().done(function(a){oa.copy({content:H.UTF8.encode(a.join("<br>")),
type:"html"});c()});else if("reset_chrome_sync"==d.name)G.reset().always(c);else if("install_tests"==d.name)(b=fa.framework.prepare(t.doSave,p.RUNTIME.BROWSER,p.RUNTIME.BROWSER_VERSION,c))&&n.error(b);else if("enabled"==d.name)k.values[d.name]=!k.values[d.name],a({});else if("installFromUrl"==d.name)t.installFromUrl(d.data).always(function(){a({})});else if("externals_delete"==d.name)O.cleanElement(d.scriptuid,d.safe_url),V.create("options.scripts").done(function(b){a({items:b,options:k.snapshot})}).fail(function(b){a({error:b,
options:k.snapshot})});else if("focus_tab"==d.name)e.focusTab.exec({},{tab:{id:d.tabid}},a);else if("run_script_updates"==d.name)if(d.scriptuid){var f;Z.check(!0,!1,d.scriptuid).done(function(a){f=a}).always(function(){a({scriptuid:d.scriptuid,updatable:f})})}else Z.check(!0,!0),a({});else n.warn("bg: Warning: unknown button "+d.name),a({})}},loadTree:{allow:{extpage:!0},exec:function(d,b,a){V.create(d.referrer,{complete:d.complete,uuid:d.uuid}).done(function(b){a({items:b,i18n:k.values.i18n,options:k.snapshot,
begging:aa.needed()})}).fail(function(b){a({error:b,options:k.snapshot})})}},modifyScriptOptions:{allow:{extpage:!0},exec:function(d,b,a){if(d.uuid){var c="options"==b.extpage||"options"==d.origin,f=void 0==d.reload||1==d.reload,h=!1,l=A.getByUid(d.uuid,!0);if(l.script&&l.cond){var m=!1,n=new y.Script;Object.keys(n.options).forEach(function(a){void 0!==d[a]&&(l.script.options[a]=d[a],h|=!0===G.SYNCED[a])});Object.keys(n.options.override).forEach(function(a){-1!=a.search("merge_")&&void 0!==d[a]&&
(l.script.options.override[a]=d[a],m=!0)});["includes","excludes","matches"].forEach(function(a){void 0!==d[a]&&(m=!0,l.script.options.override["use_"+a]=d[a])});["connects","blockers"].forEach(function(a){void 0!==d[a]&&(l.script.options.override["use_"+a]=d[a])});m&&(l.script=t.mergeCludes(l.script));d.temp_connects&&ea.setSessionConnects(l.script.uuid,d.temp_connects);void 0!==d.enabled&&(l.script.enabled=d.enabled);t.doModify(l.script.uuid,l.script,h).done(function(){f?(void 0!==d.position&&t.reorderScripts(d.uuid,
d.position),c?e.loadTree.exec({referrer:"options.scripts"},b,a):rea.tabs.getSelected(null,function(b){V.create("actions").done(function(b){a({items:b,i18n:k.values.i18n,options:{enabled:k.values.enabled,layout:k.values.layout}})}).fail(function(){a({i18n:k.values.i18n,options:{enabled:k.values.enabled,layout:k.values.layout}})});d.uuid&&k.values.autoReload&&rea.tabs.sendMessage(b.id,{method:"reload",frameId:0},function(){})})):a({})}).fail(function(){a({})});return!0}}a({})}},modifyNativeScript:{allow:{extpage:!0},
exec:function(d,b,a){if(d.nid){var g=void 0==d.reload||1==d.reload;M.getUserscriptById(d.nid).then(function(a){if(a)if("installed"==d.actionid){if("false"==d.value)return M.uninstall(a)}else{if("enabled"==d.actionid)return M.setEnabled(a,d.value);if("imported"==d.actionid&&"true"==d.value){var e=M.getUserscriptSource(a);if(e)return t.doSave({src:e,ask:!0,replace:!0}).then(function(b){if(b.installed){if("disable"==k.values.native_import_post_action)return M.setEnabled(a,!1);if("uninstall"==k.values.native_import_post_action)return M.uninstall(a)}});
rea.tabs.sendMessage(b.tab.id,{method:"showMsg",msg:c.getMessage("Please_double_check_the_native_script_import_settings__")},function(){})}}else g=!1;return m.Pledge()}).always(function(){g?e.loadTree.exec({referrer:"options.scripts"},b,a):a({})});return!0}a({})}},saveScript:{allow:{extpage:!0},exec:function(d,b,a){var e=void 0===d.reload||!!d.reload,f=function(b){e?V.create("options.scripts").done(function(d){b.items=d;b.options=k.snapshot;a(b)}).fail(function(b){a({error:b,options:k.snapshot})}):
a({})};if(d.clean){n.debug("bg: clean userscript "+d.uuid);b=A.getByUid(d.uuid);var h=function(b){V.create("options.scripts").done(function(c){a({cleaned:b.installed,items:c,options:k.snapshot});b.installed&&A.notifyStorageListeners({uuid:d.uuid},null,function(a){a({storage:A.getStorageByUid(d.uuid)})})}).fail(function(b){a({error:b,options:k.snapshot})})};b.script&&b.cond?t.doSave({name:d.name,uuid:d.uuid,src:b.script.textContent,clean:!0,ask:!1,internal:!0,save:!0}).always(function(a){h(a||{installed:!1})}):
(n.error(c.getMessage("fatal_error")+" ("+d.uuid+")!!!"),h({installed:!1}))}else if(d.code){var l=a;e&&(l=function(a){t.reorderScripts();f(a)});d.new_script&&(d.uuid=u.createUUID());t.doSave({name:d.name,uuid:d.uuid,force_url:d.force_url,src:d.code,ask:!k.values.editor_easySave,lastModified:d.lastModified,save:!0}).always(function(a){l(a||{installed:!1})})}else d.auto_save||(t.doRemove(d.uuid),t.reorderScripts()),f({})}},exportToJson:{allow:{extpage:!0},exec:function(d,b,a){t.exportToJson(d.ids,d.options).done(function(b){a({json:b})}).fail(function(){a({})})}},
importFromJson:{allow:{extpage:!0},exec:function(d,b,a){var e=void 0===d.reload||!!d.reload;t.importFromJson(d.json).fail(function(b){a({error:b||c.getMessage("An_error_occured_during_import_")})}).done(function(b){var d={reload:b.global_settings};e&&!d.reload?V.create("options.scripts").done(function(b){d.items=b;d.options=k.snapshot;a(d)}).fail(function(b){a({error:b,options:k.snapshot})}):a(d)})}},askCom:{allow:{extpage:!0},exec:function(d,b,a){ca.onMessage(d.data).always(function(b){b.i18n=k.values.i18n;
b.options={statistics_enabled:k.values.statistics_enabled};b.ext={version:rea.extension.manifest.version};a(b)})}},installScript:{allow:{insecure:!0},exec:function(d,b,a){if(b.tab){var e={};t.installFromUrl(d.url,{},{silent_fail:!0}).done(function(a){e={data:null,found:!0,installed:a}}).fail(function(a){e.err=a&&a.messages&&a.messages.errors?a.messages.errors[0]:c.getMessage("Unable_to_parse_this_")}).always(function(){a(e)})}else n.warn("bg: Error: unable to install script due to empty tabID!")}},
execMenuCmd:{allow:{extpage:!0},exec:function(d,b,a){(d=ba.getById(d.id))?d.response({run:!0,menuId:d.id}):n.warn("bg: Error: unable to find MC id "+d.id);a({})}},unLoad:{allow:{script:!0},exec:function(d,b){d.topframe||d.id&&b.frameId&&C.events.unload(b.tab.id,b.frameId,d.id)}},prepare:{allow:{script:!0},exec:function(d,b,a){if(b.tab){var c=void 0!==b.frameId?b.frameId:d.topframe?0:null,f=B.woHash(d.url);C.events.run(b.tab.id,c,d.id,f,function(c){c=c?da.answer(c,d.url):null;a(c);S.setIcon(b.tab.id);
S.setBadge(b.tab.id)});return!0}a({});return!1}},notification:{allow:{script:!0,extpage:!0},exec:function(d,b,a){var c=d.image?d.image:rea.extension.getURL("images/icon128.png");(function(){var a=m();d.highlight&&b.tab?Q.highlight(b.tab.id,a.resolve):a.resolve();return a.promise()})().then(function(){var a=m();d.text?Q.show(d.title,d.text,c,d.timeout,a.resolve):a.resolve();return a.promise()}).always(function(b){a({clicked:b&&b.clicked})})}},determineScriptsToRun:{allow:{extpage:!0},exec:function(d,
b,a){a({scripts:t.determineScriptsToRun(d.url).map(function(a){return a.uuid})})}},syntaxCheck:{allow:{script:!0,extpage:!0},exec:function(d,b,a){(function(){var a=m();Registry.require("hinter",function(){a.resolve(Registry.get("hinter"))});return a.promise()})().then(function(a){return a.hint(d.code,{maxerr:999},{})}).always(function(b){a({errors:b})})}},externalMessage:{allow:{insecure:!0},exec:function(d,b,a){d=d.request;var c;if("off"!=k.values.external_connect&&(c=b.url)&&X.isAllowed(c)){for(var f,
e,h,m=Object.keys(l.externally_connectable),w=0;w<m.length;w++)if(f=m[w],b=l.externally_connectable[f],(e=t.regexify({match:[f]}))&&t.validUrl(c,e)&&(-1!=b.indexOf("*")||-1!=b.indexOf(d.method))){h=!0;break}if(h)if("getVersion"==d.method)a({version:rea.extension.manifest.version,id:rea.runtime.short_id});else if("all"!=k.values.external_connect)n.warn("mh: calling external method "+d.method+" is not permitted to "+c+" by the user");else if("isInstalled"==d.method){var x,p,r,u;c=!1;e=d.script.name;
(p=A.getUidsByName(e,d.script.namespace)[0])&&(x=A.getByUid(p))&&x.script&&(c=!0,u=x.script.enabled,r=x.script.version);a({name:e,installed:c,enabled:u,version:r})}else n.warn("mh: unknown external method "+d.method);else n.warn("mh: calling external method "+d.method+" is not permitted to "+c)}}}},x=function(d,b,a){if(!D.late)return D.registerLateCallback(function(){x(d,b,a)}),!0;var c=e[d.method];if(c)if(c.allow&&c.exec){var f=rea.runtime.id,f=!p.REQUESTS.HAS_SENDER_ID&&b.tab||b.id===f,h=null,l=
p.REQUESTS.INTERNAL_PAGE_PROTOCOL+"//",k=p.REQUESTS.GET_INTERNAL_PAGE_REGEXP(),m=b.url?b.url:b.tab?b.tab.url:null;if(l=f&&(m?0==m.search(l):!0))m?(k=m.match(k))&&2==k.length&&(h=k[1]):h="*",b.extpage=h;k="options"==h;if("background"==h||c.allow.insecure||c.allow.extpage&&l||c.allow.options&&k||c.allow.script&&f&&!l){if(c=c.exec(d,b,a),void 0!==c)return c}else return!1===d.topframe&&(l||k)||n.warn("mh: this context doesn't have the permission to call \""+d.method+'"'),!1}else return n.warn("mh: invalid implementation of "+
d.method),!1;else return n.warn("mh: unknown method "+d.method),!1;return!0},h=function(){var d=function(b,a){var d=null,c=b.sender,e=this,h=function(a){try{b.postMessage(a)}catch(d){n.debug("bg: Error sending port ("+b.name+") message",a)}};if("xhr"==a.method){var l=!1,k=function(){b.disconnect()};a.details.convertBinary=!0;a.details.partialSize=a.details.partialSize||p.XMLHTTPREQUEST.PARTIAL_SIZE;var x={};Object.keys(a.callbacks).forEach(function(b){var d="ondone"===b;if(a.callbacks[b]||d||"onload"===
b)x[b]=function(a){a={data:a.response,exception:a.exception};a[b]=!0;h(a);d&&k()}});x.ondone||(x.ondone=k);var r=function(a){var b=m(),d=[];rea.cookies.getAll({url:a},function(a){d=d.concat(a);b.resolve(d)});return b.promise()},u;a.details.url=B.sanitize(a.details.url,a.url||c.url||null,["http:","https:"])||a.details.url;p.RUNTIME.WEBREQUEST_XHR_SUPPORT&&(a.details.headers=a.details.headers||{},a.details.headers.internal=a.uuid);(function(){return a.details.cookie&&a.details.url?r(a.details.url).then(function(b){b=
b.map(function(a){return a.name+"="+encodeURIComponent(a.value)}).concat([a.details.cookie]).join(";");delete a.details.cookie;a.details.headers=a.details.headers||{};a.details.headers.cookie=b}):m.Pledge()})().then(function(){l||(u=ea.exec(a.details,a.uuid,c||{},x))});d=function(){l=!0;u&&u.abort()}}else if("download"==a.method)I.start(a.details,{onload:function(a){h({load:!0,data:a})},onprogress:function(a){h({progress:!0,data:a})},onerror:function(a){h({error:!0,data:a})},ontimeout:function(a){h({timeout:!0,
data:a})},ondone:function(){b.disconnect()}});else if("addStorageListener"==a.method)c.tab?(A.addStorageListener(c.tab.id,a.id,a.uuid,Date.now(),h),d=function(){A.removeStorageListeners({uuid:a.uuid,id:a.id},!1)}):h({error:!0});else if("saveStorageKey"==a.method){if(c.tab){if(a.uuid){var t=A.getStorageByUid(a.uuid);t.data[a.key]=a.value;t.ts=a.ts;A.setStorageByUid(a.uuid,t);A.notifyStorageListeners({uuid:a.uuid},{id:a.id},function(b){var d={data:{},ts:0};d.data[a.key]=a.value;d.ts=a.ts;var c={storage:d};
void 0===d.data[a.key]&&(c.removed=a.key);b(c)})}}else n.warn("storage: unable to save storage due to empty tabID!");h({})}else if("openInTab"==a.method){var t=["active"],y={url:a.details.url};if(a.details.options){for(var D=0;D<t.length;D++)void 0!==a.details.options[t[D]]&&(y[t[D]]=a.details.options[t[D]]);a.details.options.insert&&(y.index=c.tab.index+1)}d=function(){e.disconnected=!0;e.tabId&&delete W[e.tabId]};rea.tabs.create(y,function(a){e.tabId=a.id;W[a.id]={onClose:function(){h({close:!0})}};
h({success:!0,tabId:a.id})})}else if("nameTab"==a.method){if(e.tabId){var G=3,H=function(){C.listeners.once.whenReady(e.tabId,function(){rea.tabs.sendMessage(e.tabId,{method:"setForeignAttr",attr:"name",value:a.name},function(b){b?h({name:a.name}):0<G--?H():n.warn("foreignAttr: error setting attr")})})};H()}}else if("closeTab"==a.method)e.tabId&&W[e.tabId]&&rea.tabs.remove(e.tabId),h({}),window.setTimeout(function(){try{e.disconnected||b.disconnect()}catch(a){}e.disconnected=!0},1E3);else if("registerMenuCommand"==
a.method)c.tab?(ba.add(c.tab.id,a.name,a.accessKey,a.menuId,h),xa(),d=function(){ba.clearById(a.menuId);xa()}):(n.warn("Unable to register menu cmd due to empty tabID!"),b.disconnect());else if("tabWatch"==a.method)if(c.tab&&c.tab.url&&(t=p.REQUESTS.GET_INTERNAL_PAGE_REGEXP())&&(y=c.tab.url.match(t))&&2==y.length&&(D=y[1])&&"options"==D){var F=null,J=function(a,c){null!==F&&c.id===F&&("updated"==a.reason?h({tab:c}):"removed"==a.reason&&(d(),b.disconnect()))};rea.tabs.create({url:a.url,index:(c.tab.index||
0)+1},function(a){F=a.id});pa.addListener(J);d=function(){null!==F&&(rea.tabs.remove(F,function(){}),F=null);pa.removeListener(J)}}else n.warn("Incomplete sender!"),b.disconnect();d&&b.onDisconnect.addListener(d)};return function(b){if(D.late){var a={};b.onMessage.addListener(function(c){d.apply(a,[b,c])})}else D.registerLateCallback(function(){h(b)})}}(),l={init:function(){l.externally_connectable_reg=t.regexify({match:Object.keys(l.externally_connectable)});rea.extension.onMessage.addListener(x);
rea.extension.onConnect.addListener(h);rea.extension.onConnectExternal.addListener(function(d){d.disconnect()})},externally_connectable:{"*://tampermonkey.net/*":["getVersion"],"https://greasyfork.org/*":["*"],"https://userstyles.org/*":["*"]}};return l}(),ya=function(){var e=[{name:c.getMessage("Default"),value:"default"},{}].filter(function(c){return c.name}),k=!1,h={default:c.getMessage("Default"),solarized:"Solarized",monokai:"Monokai",mdnlike:"MDN-like",eclipse:"Eclipse",railscasts:"RailsCasts"};
return{getLayouts:function(){if(!k){var c=ra.getLayouts().map(function(d){return{name:d.charAt(0).toUpperCase()+d.slice(1),value:d}});e=e.concat(c);k=!0}return e},getEditorThemes:function(){return ra.editorThemes.map(function(c){return{name:h[c]||c,value:c}})}}}(),ba=function(){var c=[];return{add:function(k,h,l,d,b){c.push({tabId:k,name:h,accessKey:l,id:d,response:b})},list:function(){return c},listByTabId:function(k){var h={};return c.filter(function(c){return c.tabId==k&&!h[c.name]&&(h[c.name]=
!0)})},clearByTabId:function(k){c=c.filter(function(c){return c.tabId!=k})},getByTabId:function(k){return c.filter(function(c){return c.tabId==k})[0]},clearById:function(k){c=c.filter(function(c){return c.id!=k})},getById:function(k){return c.filter(function(c){return c.id==k})[0]}}}(),Ea=function(){return{create:function(){var e,m,h,l,d,b,a,g,f,q,n,v,w,r;q=null;e={name:c.getMessage("General"),sub_menu_item:!0,items:[]};e.items.push({name:c.getMessage("Config_Mode"),id:"configMode",level:0,option:!0,
select:[{name:c.getMessage("Novice"),value:0},{name:c.getMessage("Beginner"),value:50},{name:c.getMessage("Advanced"),value:100}],value:k.values.configMode,desc:c.getMessage("Changes_the_number_of_visible_config_options")});e.items.push({name:c.getMessage("Language"),id:"i18n",level:0,option:!0,reload:!0,warning:c.getMessage("A_reload_is_required"),select:[{name:"Browser Default",value:null}].concat(c.supported),value:k.values.i18n,validation:{image:"info",opacity:.9,msg:c.getMessage("Your_language_is_not_supported__Click_here_to_get_intructions_how_to_translate_TM_"),
url:"http://tampermonkey.net/faq.php#Q500"}});e.items.push({name:c.getMessage("Auto_reload_on_script_enabled"),level:20,id:"autoReload",option:!0,checkbox:!0,enabled:k.values.autoReload,desc:c.getMessage("Auto_reload_on_script_enabled_desc")});e.items.push({name:c.getMessage("Anonymous_statistics"),level:0,id:"statistics_enabled",option:!0,checkbox:!0,enabled:k.values.statistics_enabled,validation:{image:"info",opacity:.9,msg:c.getMessage("Allow_Tampermonkey_to_collect_anonymous_statistics_via_Google_Analytics"),
url:"http://tampermonkey.net/privacy.php#extension"}});e.items.push({name:c.getMessage("Debug_scripts"),level:100,id:"debug",option:!0,checkbox:!0,enabled:k.values.debug,desc:""});e.items.push({name:c.getMessage("Show_fixed_source"),level:100,id:"showFixedSrc",option:!0,checkbox:!0,enabled:k.values.showFixedSrc,desc:""});e.items.push({name:c.getMessage("LogLevel"),id:"logLevel",level:0,option:!0,select:[{name:c.getMessage("Debug"),value:60},{name:c.getMessage("Warning"),value:30},{name:c.getMessage("Error"),
value:0}],value:k.values.logLevel,desc:""});p.OPTIONS.NATIVE_SCRIPT_IMPORT&&(m={name:c.getMessage("Native_Script_Import"),sub_menu_item:!0,need_save:!0,items:[]},q={},k.values.native_import&&(q=!0===p.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS?{image:"button_ok",msg:c.getMessage("TM_has_access_to_file_URIs")}:{image:"critical",msg:c.getMessage("Tampermonkey_needs_access_to_file_URIs__Visit_the_FAQ_"),url:"http://tampermonkey.net/faq.php#Q204"}),m.items.push({name:c.getMessage("Enable_Native_Script_Import"),
id:"native_import",level:0,option:!0,checkbox:!0,enabled:k.values.native_import,validation:q}),m.items.push({name:c.getMessage("Post_Import_Action"),id:"native_import_post_action",level:0,option:!0,select:[{name:c.getMessage("None"),value:"none"},{name:c.getMessage("Disable_Extension"),value:"disable"},{name:c.getMessage("Uninstall_Extension"),value:"uninstall"}],value:k.values.native_import_post_action,desc:c.getMessage("What_action_should_be_done_after_a_native_userscript_was_imported_sucessfully_")}),
q={},k.values.native_import&&(q=M.isPathValid()?{image:"button_ok",msg:c.getMessage("Everything_is_setup_correctly_")}:{image:"critical",msg:c.getMessage("Tampermonkey_needs_to_know_the_absolute_path_to_your_browser_profile_folder_Visit_the_FAQ_"),url:"http://tampermonkey.net/faq.php#Q205"}),m.items.push({name:c.getMessage("Browser_Profile_Path"),id:"native_import_path",level:0,option:!0,text:!0,width:2,value:k.values.native_import_path,validation:q}));p.OPTIONS.HAS_TESLA&&(v={name:c.getMessage("TESLA"),
sub_menu_item:!0,level:50,need_save:!0,items:[]},v.items.push({name:c.getMessage("Enable_TESLA"),id:"sync_enabled",level:50,option:!0,checkbox:!0,enabled:k.values.sync_enabled,desc:c.getMessage("Tampermonkey_External_Script_List_Access")}),h=[{name:"pastebin.com",value:F.types.ePASTEBIN,enable:{sync_id:!0,sync_version:!1,create_tesla_data:!0}},{name:"Chrome Sync",value:F.types.eCHROMESYNC,enable:{sync_id:!1,sync_version:!0,create_tesla_data:!1}}],p.SYNC.GOOGLE_DRIVE.SUPPORTED&&h.push({name:"Google Drive (Beta)",
value:F.types.eGOOGLEDRIVE,enable:{sync_id:!1,sync_version:!1,create_tesla_data:!1}}),v.items.push({name:c.getMessage("Sync_Type"),id:"sync_type",enabler:!0,level:50,option:!0,select:h,value:k.values.sync_type}),v.items.push({name:c.getMessage("Sync_Id"),id:"sync_id",enabledBy:"sync_type",level:50,text:!0,value:k.values.sync_id,option:!0}),v.items.push({name:c.getMessage("Sync_Version"),id:"sync_version",enabledBy:"sync_type",level:50,option:!0,select:[{name:"v1 - Legacy",value:1},{name:"v2 - Beta",
value:2,warning:c.getMessage("This_sync_version_may_multiply_each_script_that_is_present_at_more_than_one_Tampermonkey_instance__Do_you_really_want_to_continue_")}],value:k.values.sync_version,desc:c.getMessage("Different_sync_versions_are_not_compatible_to_each_other_")}),v.items.push({name:c.getMessage("Create_Exportable_Data"),id:"create_tesla_data",enabledBy:"sync_type",button:!0,ignore:!0,level:60,warning:c.getMessage("Copy_exportable_data_to_clipboard_Ok_")}));b={name:c.getMessage("Appearance"),
sub_menu_item:!0,items:[]};b.items.push({name:c.getMessage("Layout"),id:"layout",level:0,option:!0,select:ya.getLayouts(),value:k.values.layout,desc:""});q={};"off"==k.values.notification_showUpdate&&(q={image:"critical",msg:c.getMessage("Are_you_sure_that_you_don_t_want_to_be_notified_of_updates_")});b.items.push({name:c.getMessage("Update_Notification"),id:"notification_showUpdate",level:50,option:!0,select:[{name:c.getMessage("Disabled"),value:"off"},{name:c.getMessage("Show_notification"),value:"notification"},
{name:c.getMessage("Open_changelog"),value:"changelog"}],value:k.values.notification_showUpdate,validation:q});a={name:c.getMessage("Action_Menu"),sub_menu_item:!0,items:[],level:50};a.items.push({name:c.getMessage("Hide_disabled_scripts"),id:"action_menu_scripts_hide_disabled",level:100,option:!0,checkbox:!0,enabled:k.values.action_menu_scripts_hide_disabled,desc:""});a.items.push({name:c.getMessage("Columns"),id:"action_menu_columns",level:50,option:!0,select:[{name:c.getMessage("1"),value:"1"},
{name:c.getMessage("2"),value:"2"},{name:c.getMessage("3"),value:"3"}].filter(function(a){return a.value<=p.ACTIONMENU.COLUMNS}),value:k.values.action_menu_columns});a.items.push({name:c.getMessage("Script_order"),id:"action_menu_scripts_sort",level:50,option:!0,select:[{name:c.getMessage("Position_"),value:"position"},{name:c.getMessage("Name"),value:"name"},{name:c.getMessage("Enabled"),value:"enabled"}],value:k.values.action_menu_scripts_sort});a.items.push({name:c.getMessage("Icon_badge_info"),
id:"appearance_badges",level:50,option:!0,select:[{name:c.getMessage("Disabled"),value:"off"},{name:c.getMessage("Running_scripts"),value:"running"},{name:c.getMessage("Unique_running_scripts"),value:"running_unique"},{name:c.getMessage("Disabled_scripts"),value:"disabled"}],value:k.values.appearance_badges});(p.RUNTIME.CHROME||p.RUNTIME.FIREFOX)&&a.items.push({name:c.getMessage("Icon_badge_color"),id:"appearance_badge_color",level:100,color:!0,value:k.values.appearance_badge_color});h={name:c.getMessage("Editor"),
sub_menu_item:!0,level:20,need_save:!0,items:[],warning:c.getMessage("A_reload_is_required"),reload:!0};h.items.push({name:c.getMessage("Enable_Editor"),id:"editor_enabled",level:100,option:!0,checkbox:!0,enabled:k.values.editor_enabled,desc:""});h.items.push({name:c.getMessage("Theme"),id:"editor_theme",level:50,option:!0,select:ya.getEditorThemes(),value:k.values.editor_theme});h.items.push({name:c.getMessage("Font_Size"),id:"editor_fontSize",level:50,option:!0,select:[{name:"50%",value:50},{name:"70%",
value:70},{name:"80%",value:80},{name:"90%",value:90},{name:"100%",value:100},{name:"110%",value:110},{name:"120%",value:120},{name:"150%",value:150}],value:k.values.editor_fontSize});h.items.push({name:c.getMessage("Key_Mapping"),id:"editor_keyMap",level:50,option:!0,select:[{name:c.getMessage("Windows"),value:"windows"},{name:c.getMessage("Sublime"),value:"sublime"},{name:c.getMessage("Emacs"),value:"emacs"},{name:c.getMessage("Vim"),value:"vim"}],value:k.values.editor_keyMap});h.items.push({name:c.getMessage("Indentation_Width"),
id:"editor_indentUnit",level:50,option:!0,select:[{name:c.getMessage("1"),value:1},{name:c.getMessage("2"),value:2},{name:c.getMessage("3"),value:3},{name:c.getMessage("4"),value:4},{name:c.getMessage("5"),value:5},{name:c.getMessage("6"),value:6},{name:c.getMessage("7"),value:7},{name:c.getMessage("8"),value:8},{name:c.getMessage("9"),value:9},{name:c.getMessage("10"),value:10},{name:c.getMessage("11"),value:11}],value:k.values.editor_indentUnit,desc:""});h.items.push({name:c.getMessage("Indent_with"),
id:"editor_indentWithTabs",level:50,option:!0,select:[{name:c.getMessage("Tabs"),value:"tabs"},{name:c.getMessage("Spaces"),value:"spaces"}],value:k.values.editor_indentWithTabs,desc:""});h.items.push({name:c.getMessage("TabMode"),id:"editor_tabMode",level:50,option:!0,select:[{name:c.getMessage("Classic"),value:"classic"},{name:c.getMessage("Smart"),value:"smart"},{name:c.getMessage("Indent"),value:"indent"}],value:k.values.editor_tabMode,desc:""});h.items.push({name:c.getMessage("Line_break"),id:"editor_lineWrapping",
level:50,option:!0,checkbox:!0,enabled:k.values.editor_lineWrapping,desc:""});h.items.push({name:c.getMessage("Reindent_on_typing"),id:"editor_electricChars",level:50,option:!0,checkbox:!0,enabled:k.values.editor_electricChars,desc:""});h.items.push({name:c.getMessage("Enable_autoSave"),id:"editor_autoSave",level:20,option:!0,checkbox:!0,enabled:k.values.editor_autoSave,desc:""});h.items.push({name:c.getMessage("Enable_easySave"),id:"editor_easySave",level:20,option:!0,checkbox:!0,enabled:k.values.editor_easySave,
desc:""});h.items.push({name:c.getMessage("Highlight_trailing_whitespace"),id:"editor_highlightTrailingWhitespace",level:50,option:!0,checkbox:!0,enabled:k.values.editor_highlightTrailingWhitespace,desc:""});h.items.push({name:c.getMessage("Auto_syntax_check_on_typing"),id:"editor_autoLint",level:50,option:!0,checkbox:!0,enabled:k.values.editor_autoLint,desc:c.getMessage("Enable_this_option_to_automatically_check_the_code_on_typing_")});h.items.push({name:c.getMessage("Auto_syntax_check_max_length"),
id:"editor_autoLintMaxLen",level:50,option:!0,text:!0,value:k.values.editor_autoLintMaxLen,desc:c.getMessage("Check_only_scripts_up_to_this_size_automatically_")});d={name:c.getMessage("Script_Update"),sub_menu_item:!0,level:0,items:[]};d.items.push({name:c.getMessage("Check_disabled_scripts"),id:"scriptUpdateCheckDisabled",level:0,option:!0,checkbox:!0,enabled:k.values.scriptUpdateCheckDisabled,desc:""});d.items.push({name:c.getMessage("Dont_ask_me_for_simple_script_updates"),id:"notification_silentScriptUpdate",
level:80,option:!0,checkbox:!0,enabled:k.values.notification_silentScriptUpdate,desc:""});d.items.push({name:c.getMessage("Check_interval"),id:"scriptUpdateCheckPeriod",level:0,option:!0,select:[{name:c.getMessage("Never"),value:0},{name:c.getMessage("Every_6_Hours"),value:216E5},{name:c.getMessage("Every_12_Hour"),value:432E5},{name:c.getMessage("Every_Day"),value:864E5},{name:c.getMessage("Every_Week"),value:6048E5}],value:k.values.scriptUpdateCheckPeriod,desc:""});d.items.push({name:c.getMessage("Hide_notification_after"),
id:"scriptUpdateHideNotificationAfter",level:50,option:!0,select:[{name:c.getMessage("Never"),value:0},{name:c.getMessage("15_Seconds"),value:15E3},{name:c.getMessage("30_Seconds"),value:3E4},{name:c.getMessage("1_Minute"),value:6E4},{name:c.getMessage("5_Minutes"),value:3E5},{name:c.getMessage("1_Hour"),value:36E5}],value:k.values.scriptUpdateHideNotificationAfter,desc:""});l={name:c.getMessage("Externals"),sub_menu_item:!0,level:0,items:[]};l.items.push({name:c.getMessage("Update_interval"),id:"external_update_interval",
level:0,option:!0,select:[{name:c.getMessage("Always"),value:1},{name:c.getMessage("Every_Day"),value:864E5},{name:c.getMessage("Every_Week"),value:6048E5},{name:c.getMessage("Every_Month"),value:2592E6},{name:c.getMessage("Never"),value:0}],value:k.values.external_update_interval,desc:""});g={name:c.getMessage("Security"),sub_menu_item:!0,level:50,items:[]};p.OPTIONS.HAS_CSP&&(g.items.push({name:c.getMessage("Add_TM_to_CSP"),id:"webrequest_fixCSP",level:80,option:!0,select:[{name:c.getMessage("Yes"),
value:"yes"},{name:c.getMessage("No"),value:"no"}],value:k.values.webrequest_fixCSP,desc:c.getMessage("Tampermonkey_might_not_be_able_to_provide_access_to_the_unsafe_context_when_this_is_disabled")}),g.items.push({name:c.getMessage("Allow_headers_to_be_modified_by_scripts"),id:"webrequest_modHeaders",level:80,option:!0,reload:!0,select:[{name:c.getMessage("Yes"),value:"yes"},{name:c.getMessage("Auto"),value:"auto"},{name:c.getMessage("No"),value:"no"}],value:k.values.webrequest_modHeaders,warning:c.getMessage("Tampermonkey_needs_to_be_restarted_to_make_this_change_apply_Do_you_want_to_continue_"),
desc:""}));g.items.push({name:c.getMessage("Allow_communication_with_cooperate_pages"),id:"external_connect",level:80,option:!0,reload:!0,select:[{name:c.getMessage("Tampermonkey_and_script_version"),value:"all"},{name:c.getMessage("Tampermonkey_version"),value:"version"},{name:c.getMessage("Disabled"),value:"off"}],value:k.values.external_connect,desc:c.getMessage("This_option_allows_the_Tampermonkey_homepage_and_some_script_hosting_pages_to_determine_the_Tampermonkey_version_and_whether_a_script_is_installed_")});
g.items.push({name:c.getMessage("Subresource_Integrity"),id:"require_sri_mode",level:80,option:!0,select:[{name:c.getMessage("Disabled"),value:"ignore"},{name:c.getMessage("Validate_if_supported"),value:"supported"},{name:c.getMessage("Validate_if_given"),value:"given"},{name:c.getMessage("Enforce"),value:"enforce"}],value:k.values.require_sri_mode,desc:c.getMessage("Script_authors_can_secure_external_resources_by_adding_a_SRI_hash_to_the_URL_")});g.items.push({name:c.getMessage("connect_mode"),id:"connect_mode",
level:50,option:!0,select:(80<=k.values.configMode||-1!=["off","casual"].indexOf(k.values.connect_mode)?[{name:c.getMessage("Disabled"),value:"off"},{name:c.getMessage("Casual"),value:"casual"}]:[]).concat([{name:c.getMessage("Ask_if_unknown"),value:"ask"},{name:c.getMessage("Strict"),value:"strict"},{name:c.getMessage("Always_ask"),value:"paranoid"}]),value:k.values.connect_mode,desc:""});p.RUNTIME.INCOGNITO_MODE&&!rea.extension.inIncognitoContext&&(q="temporary"==k.values.incognito_mode?{}:{image:"critical",
msg:"Permanent mode is still a BETA feature!"},g.items.push({name:c.getMessage("Store_data_in_incognito_mode"),id:"incognito_mode",level:50,option:!0,select:[{name:c.getMessage("Temporary"),value:"temporary"},{name:c.getMessage("Permanent"),value:"permanent"}],value:k.values.incognito_mode,validation:q}));g.items.push({name:c.getMessage("Page_Filter_Mode"),id:"page_filter_mode",level:50,option:!0,select:[{name:c.getMessage("Disabled"),value:"off"},{name:c.getMessage("Blacklist"),value:"black"},{name:c.getMessage("Whitelist"),
value:"white"},{name:c.getMessage("Both"),value:"black+white"}],value:k.values.page_filter_mode,desc:""});g.items.push({name:c.getMessage("Whitelisted_Pages"),id:"page_whitelist",level:50,option:!0,input:!0,array:!0,value:k.values.page_whitelist,desc:""});g.items.push({name:c.getMessage("Blacklisted_Pages"),id:"forbiddenPages",level:50,option:!0,input:!0,array:!0,value:k.values.forbiddenPages,desc:""});f={name:c.getMessage("BlackCheck"),sub_menu_item:!0,level:50,items:[]};f.items.push({name:c.getMessage("Script_Blacklist_Source"),
id:"script_blacklist_type",level:50,option:!0,select:[{name:c.getMessage("Disabled"),value:"off"},{name:c.getMessage("Server_And_Manual"),value:"server"},{name:c.getMessage("Only_Manual"),value:"only_manual"}],value:k.values.script_blacklist_type});f.items.push({name:c.getMessage("Blacklist_Severity"),id:"script_blacklist_severity",level:50,option:!0,select:[{name:c.getMessage("severity_1"),value:1},{name:c.getMessage("severity_2"),value:2},{name:c.getMessage("severity_3"),value:3},{name:c.getMessage("severity_4"),
value:4},{name:c.getMessage("severity_5"),value:5},{name:c.getMessage("severity_6"),value:6},{name:c.getMessage("severity_7"),value:7},{name:c.getMessage("severity_8"),value:8},{name:c.getMessage("severity_9"),value:9},{name:c.getMessage("severity_10"),value:10}],value:k.values.script_blacklist_severity});f.items.push({name:c.getMessage("Manual_Script_Blacklist"),id:"require_blacklist",level:50,option:!0,input:!0,array:!0,value:k.values.require_blacklist,desc:""});if(p.OPTIONS.CAN_DOWNLOAD){var t=
!1;q={};u.map("exe sh crx com bat scr".split(" "),function(a){return"name."+a}).forEach(function(a){t|=I.is_whitelisted(a)});t&&(q={image:"critical",msg:c.getMessage("Your_whitelist_seems_to_include_executable_files_This_means_your_userscripts_may_download_malware_or_spyware_to_your_harddisk_")});r={name:c.getMessage("Downloads")+" BETA",sub_menu_item:!0,level:50,items:[]};r.items.push({name:c.getMessage("Download_Mode"),id:"downloads_mode",level:50,option:!0,select:u.select([{name:c.getMessage("Default"),
value:I.staticVars.DEFAULT},{name:c.getMessage("Disabled"),value:I.staticVars.OFF},{name:c.getMessage("Native"),value:I.staticVars.NATIVE},{name:c.getMessage("Browser_API"),value:rea.downloads.supported?I.staticVars.CHROME:null}],function(a){return a.value}),value:k.values.downloads_mode,desc:c.getMessage("The_Browser_API_mode_requires_a_special_permission_")});r.items.push({name:c.getMessage("Whitelisted_File_Extensions"),id:"downloads_extension_whitelist",level:50,option:!0,input:!0,array:!0,value:k.values.downloads_extension_whitelist,
desc:c.getMessage("Only_files_with_these_extensions_can_be_saved_to_the_harddisk_Be_careful_to_not_allow_file_extensions_that_represent_executables_at_your_operating_system_"),validation:q})}n={name:c.getMessage("Experimental"),sub_menu_item:!0,level:80,items:[]};p.RUNTIME.FAST_EXEC_SUPPORT&&(q="fast"==k.values.runtime_inject_mode?{image:"critical",msg:"This might cause higher CPU usage!"}:{},n.items.push({name:c.getMessage("Inject_Mode"),id:"runtime_inject_mode",level:80,option:!0,select:[{name:c.getMessage("Default"),
value:"default"},{name:c.getMessage("Fast"),value:"fast"},{name:c.getMessage("Normal"),value:"normal"}],value:k.values.runtime_inject_mode,validation:q}));n.items.push({name:c.getMessage("strict_mode"),id:"runtime_strict_mode",level:80,option:!0,select:[{name:c.getMessage("Default"),value:"byscript"},{name:c.getMessage("Always"),value:"on"},{name:c.getMessage("Disabled"),value:"off"}],value:k.values.runtime_strict_mode});q={name:c.getMessage("Userscripts"),sub_menu_item:!0,level:80,items:[]};q.items.push({name:c.getMessage("Script_URL_detection"),
id:"scriptUrlDetection",level:80,option:!0,select:[{name:c.getMessage("Auto"),value:"auto"},{name:c.getMessage("Disabled"),value:"manual"}],value:k.values.scriptUrlDetection});q.items.push({name:c.getMessage("New_script_template_"),id:"script_templates",level:80,option:!0,input:!0,array:!0,named:!0,value:k.values.script_templates});w={name:c.getMessage("Reset_Section"),sub_menu_item:!0,level:50,items:[]};w.items.push({name:c.getMessage("Restart_Tampermonkey"),id:"reset_simple",level:50,button:!0,
reload:!0,value:0,warning:c.getMessage("This_will_restart_Tampermonkey_Ok_")});w.items.push({name:c.getMessage("Factory_Reset"),id:"reset_factory",level:80,button:!0,reload:!0,value:0,warning:c.getMessage("This_will_remove_all_scripts_and_reset_all_settings_Ok_")});p.OPTIONS.HAS_TESLA&&w.items.push({name:c.getMessage("Chrome_Sync_Reset"),id:"reset_chrome_sync",level:80,button:!0,reload:!0,value:0,warning:c.getMessage("This_will_remove_all_stored_data_from_google_sync_Ok_")});fa&&w.items.push({name:"Install Tests",
id:"install_tests",level:80,button:!0,reload:!1,ignore:!0,value:0,warning:"This will install a lot of test scripts!"});return[e,b,a,d,l,void 0,v,m,void 0,h,g,f,r,q,n,w].filter(function(a){return!!a})}}}(),V=function(){return{create:function(e,x){e=e||"";x=x||{};var h=function(b){return m.onebyone(b).fail(function(){n.warn("tree: wait failed!")}).then(function(a){return a.filter(function(a){return a})})},l=function(b,a){for(var c=b.replace(/\.$/,"").split("."),f=d;c.length;){var e=c.shift();if(f[e]){if("function"===
typeof f[e])return function(){return f[e](x,!a)};f=f[e];c.length||c.unshift("root")}else return n.warn("tree: unable to find",b,x),function(){return m.Pledge([])}}n.warn("tree: unable to find",b,x);return function(){return m.Pledge([])}},d={actions:{root:function(){var b=m();rea.tabs.getSelected(null,function(a){x.tab=a;a=h([l("actions.general"),l("actions.scripts"),l("actions.commands")]);b.consume(a)});return b.promise()},general:function(){var b=x.tab,a=b?b.url:null,d=a&&4<a.length&&""==a.substr(0,
4).replace(/file|http/,"")?a:"",b=[],e={name:"enabled",sub_menu_item:!0,pos:"top",items:[]};e.items.push({name:c.getMessage("Enabled"),display:k.values.enabled?null:"greyed",id:"enabled",button:!0,reload:!0,enabler:!0});b.push(e);"manual"==k.values.scriptUrlDetection&&ka.isScriptUrl(a)&&e.items.push({name:c.getMessage("Install_this_script"),image:"script_download",id:"installFromUrl",data:a,button:!0,reload:!0});a={name:"about",sub_menu_item:!0,pos:"bottom",items:[]};a.items.push({name:c.getMessage("Dashboard"),
image:"utilities",url:rea.extension.getURL("options.html")+"#"+["url="+H.Base64.encode(d),"nav=dashboard"].join("&"),newtab:!0});d="version="+rea.extension.manifest.version+"&ext="+rea.runtime.short_id;a.items.push({image:"info",urls:[{name:" "+c.getMessage("Help"),url:"http://tampermonkey.net/faq.php?"+d,newtab:!0},{name:" "+c.getMessage("Changelog"),url:"http://tampermonkey.net/changelog.php?"+d,newtab:!0}]});b.push(a);return m.Pledge(b)},scripts:function(){var b=x.tab,a=b?b.url:null,d=[],e=a&&
4<a.length&&""==a.substr(0,4).replace(/file|http/,"")?a:"",h,l={name:"scripts",sub_menu_item:!0,pos:"center",items:[]},b=t.getUniqueScriptsForTab(b),n=da.getContexters(0,null),b=na([].concat(b).concat(n)),w;"position"!=k.values.action_menu_scripts_sort&&("name"==k.values.action_menu_scripts_sort?w=function(a,b){return a.name.toLowerCase()<b.name.toLowerCase()?-1:a.name.toLowerCase()>b.name.toLowerCase()?1:0}:"enabled"==k.values.action_menu_scripts_sort&&(w=function(a,b){return b.enabled-a.enabled}));
k.values.action_menu_scripts_hide_disabled&&(b=b.filter(function(a){return a.enabled}));w&&b.sort(w);!k.values.action_menu_scripts_hide_disabled&&2<Math.min(k.values.action_menu_columns,p.ACTIONMENU.COLUMNS)?(h={name:"scripts_right",sub_menu_item:!0,pos:"right",items:[]},b.forEach(function(a){(a.enabled?l:h).items.push(a)}),d.push(l),h.items.length&&d.push(h)):(h=l,l.items=l.items.concat(b),d.push(l));k.values.enabled&&!b.length&&a&&(X.isAllowed(a)?l.items.push({name:c.getMessage("No_script_is_running"),
image:"info"}):l.items.push({name:c.getMessage("This_page_is_blacklisted_at_the_security_settings"),image:"critical"}));a=c.getLocale();k.values.enabled&&("3"==k.values.action_menu_columns||100>k.values.configMode||!b.length)&&(b.length?(w={name:"scripts_new",sub_menu_item:!0,pos:"center",items:[]},d.push(w)):w=l,w.items.push({name:c.getMessage("Get_new_scripts___"),image:"script_download",url:"http://tampermonkey.net/scripts.php"+(a?"?locale="+a:""),newtab:!0}),w.items.push({name:c.getMessage("Add_new_script___"),
image:"script_add",url:rea.extension.getURL("options.html")+"#url="+H.Base64.encode(e)+"&nav=new-user-script",newtab:!0}));return m.Pledge(d)},commands:function(){var b=x.tab,a=[],d=c.getLocale(),e={name:"commands",id:"commands",sub_menu_item:!0,pos:"left",items:[]},h=b.id,b=[],h=null==h||void 0==h?ba.list():ba.listByTabId(h),l;for(l in h)if(h.hasOwnProperty(l)){var n=h[l];b.push({name:n.name,id:n.id,accessKey:n.accessKey,image:"menu_cmd",menucmd:!0})}b.length&&(e.items=b);e.items.push({name:c.getMessage("Check_for_userscripts_updates"),
id:"run_script_updates",button:!0,image:"update"});80<=k.values.configMode&&e.items.push({name:c.getMessage("Report_a_bug"),image:"bug",url:"http://tampermonkey.net/bug",newtab:!0});e.items.push({name:c.getMessage("Please_consider_a_contribution"),image:"contrib",url:"http://tampermonkey.net/contrib.php"+(d?"?locale="+d:""),newtab:!0});a.push(e);return m.Pledge(a)}},options:{root:function(){return h([l("options.general"),l("options.verification"),l("options.scripts"),l("options.settings")])},general:function(){var b=
[];b.push({name:"Version",id:null,version:!0,value:rea.extension.manifest.version});rea.extension.inIncognitoContext&&"temporary"==k.values.incognito_mode&&b.push({globalhint:!0,image:"critical",value:c.getMessage("All_modifications_are_only_kept_until_this_incognito_session_is_closed_")});return m.Pledge(b)},verification:function(){var b=[];ga.getWarnings().forEach(function(a){b.push({globalhint:!0,image:"critical",value:a.text,description:a.description,info_url:a.url})});return m.Pledge(b)},scripts:{root:function(b,
a){var d=m(),e={name:c.getMessage("Installed_userscripts"),main_menu_item:!0,scriptTab:!0,id:"dashboard"};(function(){if(b.complete||!a)return h(u.map(["options.scripts.natives","options.scripts.userscripts","options.scripts.new"],function(a){return l(a)}));e.referrer="options.scripts";e.partial=!0;return h([l("options.scripts.new")])})().done(function(a){e.items=a;d.resolve([e])}).fail(d.reject);return d.promise()},"new":function(){var b=[];b.push({name:c.getMessage("New_userscript"),id:null,image:"script_add",
icon:rea.extension.getURL("images/txt.png"),nnew:!0,uuid:"new-user-script",position:-1,positionof:p.RUNTIME.MAX_SCRIPTS,enabled:!0,userscript:!0});return m.Pledge(b)},natives:function(){var b=[],a=m();M.getAllUserscripts().always(function(d){d=d||[];d.forEach(function(a){b.push({name:a.name,uuid:a.id,icon:a.icon,code:null,position:0,positionof:p.RUNTIME.MAX_SCRIPTS,enabled:a.enabled,version:a.version,description:a.description,nativeScript:!0})});a.resolve(b)});return a.promise()},userscripts:{root:function(b,
a){var d=b.complete||!a?null:"options.scripts.userscripts.source",d=na(t.determineScriptsToRun(null),!0,d),e=d.length,h=c.getLocale();d.push({name:c.getMessage("No_script_is_installed"),image:"info",visible:!e});d.push({name:c.getMessage("Get_some_scripts___"),image:"edit_add",url:"http://tampermonkey.net/scripts.php"+(h?"?locale="+h:""),newtab:!0,visible:!e});return m.Pledge(d)},source:function(b){if(!b.uuid)return m.Pledge([]);b=A.getByUid(b.uuid);if(b.script&&b.cond)return b=k.values.showFixedSrc?
ja.mkCompat(b.script.textContent,b.script,"off"!=k.values.runtime_strict_mode):b.script.textContent,m.Pledge([b]);n.warn("tree: unable to process ",b);return m.Breach()}}},settings:function(b,a){var d=m(),e={name:c.getMessage("Settings"),main_menu_item:!0,id:"settings",selected_default:!0},h;b.complete||!a?h=m.Pledge(Ea.create()):(e.referrer="options.settings",h=m.Pledge());h.done(function(a){e.items=a;d.resolve([e])}).fail(d.reject);return d.promise()}}};n.debug("tree: loading",e,x);return l(e,!0)()}}}(),
na=function(c,m,h){var l=[],d=new y.Script;["author","copyright"].forEach(function(b){d[b]=!1});Object.keys(c).forEach(function(b){var a=c[b],g;if(m){g={};var f=["textContent","requires","resources"];Object.keys(d).forEach(function(b){-1==f.indexOf(b)&&(u.toType(d[b]),g[b]=a[b])});h?(g.referrer=h,g.length=a.textContent.length):g.code=a.textContent;["requires","resources"].forEach(function(b){g[b]=u.map(a[b],function(b){var d=b.url||B.sanitize(b.unsafe_url,b.abs_url),c=O.getElement(a.uuid,d),e=0,f=
null,g=null;c&&c.data&&(c.data.content&&(e=c.data.content.length),g=c.data.sri,f=c.ts);return{display_url:b.url||b.unsafe_url,url:d,data:{length:e},sri:g,ts:f}})});g.origin=t.determineOrigin(a);g.contexter=t.isContexter(a);g.temp_connects=ea.getSessionConnects(a.uuid)}else g={name:a.name,uuid:a.uuid,system:a.system,support:!!a.supportURL,origin:!!t.determineOrigin(a),contexter:t.isContexter(a),enabled:a.enabled,position:a.position};g.blacklisted=a.evilness>=k.values.script_blacklist_severity;a.evilness&&
(g.warnings=R.getWarningsFor(t.determineSourceURL(a)));g.file_url=a.downloadURL||a.fileURL;g.positionof=c.length;g.userscript=!0;a.icon64||a.icon||(g.icon64=rea.extension.getURL("images/txt.png"));a.options&&Object.keys(d.options).forEach(function(b){g[b]=a.options[b]});l.push(g)});return l},oa={copy:function(c){var k=document.createElement("iframe"),h=document.body||document.documentElement||document;h.appendChild(k);try{k.contentDocument.designMode="on","html"==c.type?(k.setAttribute("sandbox",
"allow-same-origin"),k.contentDocument.documentElement.innerHTML=c.content,k.contentDocument.execCommand("selectAll",!1,null)):k.contentDocument.oncopy=function(h){h.clipboardData.setData(c.mimetype||"text/plain",c.content);h.preventDefault()},k.contentDocument.execCommand("copy",!1,null),k.contentDocument.designMode="off"}catch(l){n.warn("bg: clipboard Error: "+l.message)}h.removeChild(k);k=null}};clip=oa;var U={run:function(c,k){var h=1,l=function(){0==--h&&(k&&k(),rea.page.reload())};if("config"==
c){var d=r.listValues();Object.keys(d).forEach(function(b){b=d[b];-1==b.search(p.CONSTANTS.PREFIX.SCRIPT)&&-1==b.search(p.CONSTANTS.PREFIX.COND)&&-1==b.search(p.CONSTANTS.PREFIX.STORE)&&-1==b.search(p.CONSTANTS.PREFIX.META)&&(h++,r.deleteValue(b).always(l))})}else"factory"==c&&(h++,I.remove_permission().done(l),h++,r.factoryReset().always(l));l()},reset:function(c){U.run(null,c)},factoryReset:function(c){U.run("factory",c)},configReset:function(c){U.run("config",c)}},S=function(){var e=function(){rea.runtime.lastError&&
void 0},m={init:function(){m.setIcon();var c=k.values.appearance_badge_color||"#ee3131";"#"!==c[0]&&(c="#"+c);rea.browserAction.setBadgeBackgroundColor({color:c})},setIcon:function(h){var l,d;d=null;var b=l=!1;void 0===h||C.get.empty(h)||(l=C.get.blocker(h),b=C.get.forbidden(h));b?(l="_forbidden",d=c.getMessage("At_least_one_part_of_this_page_is_listed_at_the_forbidden_pages_setting_")):l?(l="_blocker",d=c.getMessage("Some_scripts_might_be_blocked_by_the_javascript_settings_for_this_page_or_a_script_blocker_")):
l=k.values.enabled&&void 0!==h?"":"_grey";n.debug("badge: set icon "+l);l={path:rea.extension.getURL("images/icon"+l+".png")};d={title:d?d:rea.extension.manifest.name};null!=h&&(l.tabId=h,d.tabId=h);try{rea.browserAction.setIcon(l,e),rea.browserAction.setTitle(d)}catch(a){n.warn("bg: ERROR while setIcon! "+a.message)}},setBadge:function(c){var e=0;"off"==k.values.appearance_badges?e=0:"running"==k.values.appearance_badges?c&&!C.get.empty(c)&&(e=C.get.stats(c).running):"running_unique"==k.values.appearance_badges?
c&&!C.get.empty(c)&&(e=C.get.stats(c,!0).unique):"disabled"==k.values.appearance_badges&&c&&!C.get.empty(c)&&(e=C.get.stats(c).disabled);n.debug("badge: set "+e);e?rea.browserAction.setBadgeText({text:e.toString(),tabId:c}):rea.browserAction.setBadgeText({text:"",tabId:c})}};return m}(),aa=function(){var c=null,k={init:function(){c=r.getValue(p.CONSTANTS.STORAGE.BEGGING,null);if(!c){c={};var h=Date.now(),l=h;u.each(t.determineScriptsToRun(null),function(c){c.lastUpdated&&c.lastUpdated<l&&(l=c.lastUpdated)});
l!==h?(n.debug("beg: first action found at "+(new Date(l)).toISOString()),c.first_run={type:"from_script",ts:l}):c.first_run={type:"from_init",ts:h};k.save()}},save:function(){r.setValue(p.CONSTANTS.STORAGE.BEGGING,c)},needed:function(){var h=Date.now(),k=c.first_run?c.first_run.ts+12096E5<h:!0,d=!c.hide,b=!c.contributed,h=c.later?c.later.ts+12096E5<h:!0;return!p.RUNTIME.DOLPHIN&&k&&d&&b&&h},clicked:function(c,e,d){L.tG("clicked",c,e+d)},dialog:{shown:function(h){var l=Date.now();c.dialog={ts:l,extra:h};
k.save();L.tG("dialog")}},button:function(){var h={};["contributed","later","hide"].forEach(function(l){h[l]=function(d){var b=Date.now();c[l]={ts:b,extra:d};k.save();L.tG("button",l)}});return h}()};return k}(),ha=function(){var c=function(a,b){n.debug(a,b);if(b&&a.menuItemId){var c=A.getByUid(a.menuItemId);c&&c.script?ua.bundle({url:a.frameUrl||a.pageUrl||"<unknown>"},c.script,!0).then(function(c){var d=m();c.method="executeScript";a.frameUrl?c.url=B.woHash(a.frameUrl):c.topframe=!0;rea.tabs.sendMessage(b.id,
c,d.resolve);return d.promise()}):n.debug("ctxm: unable to find script "+a.menuItemId,a,b)}},k=[],h=null,l=!1,d=function(a){var b=[];u.each(a,function(a){var c=m();rea.contextMenus.create({id:a.uuid,contexts:["all"],parentId:h,title:a.name,type:"normal",documentUrlPatterns:["http://*/*","https://*/*","file://*/*"]},function(){c.resolve()});k.push(a.uuid);b.push(c.promise())});return m.when(b)},b=function(){var a=m();rea.contextMenus.removeAll(function(){h=null;a.resolve()});return a.promise()},a=
function(){var a=m();b().then(function(){h=rea.contextMenus.create({contexts:["all"],title:"Tampermonkey",type:"normal",documentUrlPatterns:["http://*/*","https://*/*","file://*/*"]},function(){a.resolve()})});return a.promise()},g=function(){var c=da.getContexters(0,null);if(c.length){var e;e=h?m.Pledge():a();return e.then(function(){return d(c)})}return b().then(f.clean)},f={init:function(){rea.contextMenus.supported&&(f.clean().then(g).then(function(){l=!0}),rea.contextMenus.onClicked.addListener(c))},
clean:function(){var a=m();k.forEach(function(a){rea.contextMenus.remove(a)});k=[];a.resolve();return a.promise()},onScriptsChanged:function(){if(rea.contextMenus.supported&&l)return f.clean().then(g)},getContexterCount:function(){return k.length}};return f}(),qa=function(){var c={},m={},h=("TM_"+u.createUUID().substr(0,5)).toLowerCase(),l=["x-webkit-csp","x-content-security-policy","content-security-policy"],d={getPrefix:function(){return h},onBeforeSendHeaders_xml:function(b){var a=[],c=b.requestHeaders||
[],d,e,k={},l=new RegExp("^"+h),c=c.filter(function(c){if(c.name&&0==c.name.search(l))e=c.name.replace(l,""),k[e.toLowerCase()]=!0,"internal"==e?m[b.requestId]=c.value:a.push({name:e,value:c.value}),d=!0;else return!0});if(d)return{requestHeaders:c.filter(function(a){return!a.name||!k[a.name.toLowerCase()]}).concat(a)}},onBeforeRequest_main_frame:function(b){if(D.late){if(C.events.reset(b.tabId,!0),0<b.tabId&&"POST"!=b.method&&"auto"==k.values.scriptUrlDetection&&ka.isScriptUrl(b.url))return t.installFromUrl(b.url,
{},{silent_fail:!0}).fail(function(a){n.info("webRequest: user script detected @ "+b.url+" was invalid",a?a.messages:"");rea.tabs.update(b.tabId,{url:b.url+"#bypass=true"},function(){})}).done(function(){p.RUNTIME.EDGE&&rea.tabs.query({windowType:"normal"},function(a){a.forEach(function(a){a.id===b.tabId&&rea.tabs.update(a.id,{url:a.url},function(){})})})}),p.RUNTIME.EDGE?{cancel:!0}:{redirectUrl:"javascript:history.back()"}}else D.registerLateCallback(function(){d.onBeforeRequest_main_frame(b)})},
onHeadersReceived_frame_xml:function(b){if(D.late){var a=b.responseHeaders||[];if("xmlhttprequest"==b.type){var g,f;(g=m[b.requestId])&&delete m[b.requestId];(f=c[b.requestId])&&delete c[b.requestId];if(g&&f)return a.push({name:"TM-finalURL"+rea.runtime.short_id,value:f}),{responseHeaders:a}}else{var h,n,r,w=p.OPTIONS.HAS_CSP&&"yes"==k.values.webrequest_fixCSP;a.forEach(function(a){a.name&&a.value&&(a=a.name.toLowerCase(),w&&-1!=l.indexOf(a)?r=!0:"location"==a&&(n=!0))});if(!n&&C.events.response(b.tabId,
b.frameId,b.url)){if((p.RUNTIME.EXEC_SCRIPT_SUPPORT||p.RUNTIME.FAST_EXEC_SUPPORT&&-1!=["fast"].indexOf(k.values.runtime_inject_mode))&&(g=C.events.run(b.tabId,b.frameId,null,b.url))){var t=da.answer(g,b.url);if(p.RUNTIME.EXEC_SCRIPT_SUPPORT)rea.tabs.executeScript(b.tabId,{frameId:b.frameId,runAt:"document_start",code:"debugger; window.tm_info = "+JSON.stringify(t)});else{var u=5,y=function(){C.get.exec(b.tabId,b.frameId)||(t.method="fastExec",rea.tabs.sendMessage(b.tabId,t,{frameId:b.frameId},function(a){var c=
rea.runtime.lastError;c&&!a&&0<--u?C.get.exec(b.tabId,b.frameId)||y():c||a&&(C.get.exec(b.tabId,b.frameId)||a.late||C.events.exec(b.tabId,b.frameId,b.url))}))};window.setTimeout(y,k.values.runtime_inject_delay)}}if(r&&(a.forEach(function(b,c){if(b.name&&b.value){var d=b.name.toLowerCase();if(-1!=l.indexOf(d)){var e=!1,f,g,d=b.value.split(";").map(function(a,b){var c=a.trim();if(0===c.search(/^script-src /)){f=!0;var d=-1!=c.search(/'unsafe-eval'/),k=-1!=c.search(/'none'/);if(!d||k)return h=e=!0,c.replace(/script-src /,
"script-src 'unsafe-eval' ").replace(/ 'none'/,"")}else 0===c.search(/^default-src /)&&(g={i:b,v:c});return c});g&&!f&&(d.splice(g.i+1,0,g.v.replace(/default-src /,"script-src 'unsafe-eval' ").replace(/ 'none'/,"")),h=e=!0);a[c]={name:b.name,value:e?d.join(";"):b.value}}}}),h))return{responseHeaders:a}}}}else D.registerLateCallback(function(){d.onHeadersReceived_frame_xml(b)})},onBeforeRedirect_xml:function(b){c[b.requestId]=b.redirectUrl},onResponseStarted_frame:function(b){D.late?b.fromCache&&C.events.response(b.tabId,
b.frameId,b.url):D.registerLateCallback(function(){d.onResponseStarted_frame(b)})},onErrorOccurredListener_main_frame:function(){var b=/ERR_NAME_NOT_RESOLVED/,a=/^([a-z0-9][a-z0-9\-]*[a-z0-9]\.{0,3})*(\.[a-z0-9\-]{2,15})+$/i,c=u.getDebouncer(3E5);return function(d){var e,h;!D.late&&-1===["gcal"].indexOf(rea.runtime.short_id)&&!p.RUNTIME.EDGE&&"http"===d.url.substr(0,4)&&b.exec(d.error)&&(e=B.woPath(d.url).replace(/https?:\/\//,""))&&a.exec(e)&&!c.is(e,!0)&&(h=t.regexify({inc:["*.tld/*"]}))&&t.validUrl(d.url,
h)&&(h=C.events.response(d.tabId,d.frameId||0,d.url),L.tN(e,d.error,h));C.events.reset(d.tabId,!0)}}(),init:function(b){try{var a=p.RUNTIME.EDGE?["http://*/*","https://*/*"]:["<all_urls>"];b?(rea.webRequest.onBeforeRequest.addListener(d.onBeforeRequest_main_frame,{urls:a,types:["main_frame"]},["blocking"]),rea.webRequest.onHeadersReceived.addListener(d.onHeadersReceived_frame_xml,{urls:a,types:["main_frame","sub_frame","xmlhttprequest"]},["blocking","responseHeaders"]),p.RUNTIME.WEBREQUEST_XHR_SUPPORT&&
rea.webRequest.onBeforeRedirect.addListener(d.onBeforeRedirect_xml,{urls:a,types:["xmlhttprequest"]},[]),rea.webRequest.onResponseStarted.addListener(d.onResponseStarted_frame,{urls:a,types:["main_frame","sub_frame"]},[]),rea.webRequest.onErrorOccurred.addListener(d.onErrorOccurredListener_main_frame,{urls:a,types:["main_frame"]})):"no"!=k.values.webrequest_modHeaders&&rea.webRequest.onBeforeSendHeaders.addListener(d.onBeforeSendHeaders_xml,{urls:a,types:["xmlhttprequest"]},["blocking","requestHeaders"]);
rea.webRequest.handlerBehaviorChanged()}catch(c){n.warn("webRequest: error initializings",c.message)}}};return d}(),Fa=function(){var c=function(c){C.events.commited(c.tabId,c.frameId,c.url)};return{init:function(){rea.webNavigation.supported&&rea.webNavigation.onCommitted.addListener(c)}}}(),D={late:!1,callbacks:[],init:function(){},registerLateCallback:function(c){n.debug("toea: register callback");D.callbacks.push(c)},setReady:function(){n.debug("toea: run "+D.callbacks.length+" callbacks");D.late=
!0;for(var c=0;c<D.callbacks.length;c++)D.callbacks[c]();D.callbacks=[]}},Ga=function(){var c=!1,k=null,h=function(){c||(n.debug("Unloader.onbeforeunload()"),k&&k(),c=!0)};return{init:function(c){k=c;window.addEventListener("beforeunload",h,!1)}}}(),Aa=function(){var e=rea.extension.manifest.version,t=null,h=!1,l=!1,d=function(){if(D.late){var a="version="+e+"&ext="+rea.runtime.short_id+"&updated=true",b;h?(b="http://tampermonkey.net/installed.php?"+a,l=!0):(a+="&old="+t,b="http://tampermonkey.net/changelog.php?"+
a);"off"!=k.values.notification_showUpdate&&("notification"==k.values.notification_showUpdate?Q.showUpdate(c.getMessage("Updated_to__0version0",e),c.getMessage("Click_here_to_see_the_recent_changes"),rea.extension.getURL("images/icon128.png"),function(a){a.clicked&&rea.tabs.create({url:b},function(){})}):"changelog"==k.values.notification_showUpdate&&(l||(b+="&intr=true"),l=!0,rea.tabs.create({url:b,active:l},function(){})))}else D.registerLateCallback(d)},b=function(){var a=null,b,c=m(),d=function(){b&&
(b=null,c.resolve(!!a))};b=window.setTimeout(d,300);rea.idle.queryState(p.MISC.IDLE_TIMEOUT,function(b){a="active"==b;d()});return c.promise()},a=function(b){D.late?(n.debug("upd: onInstalled",b),b||(b={reason:"mandatory_argument_is_not_set"}),"chrome_update"==b.reason?L.tB({updated:!0}):"install"!=b.reason&&"update"!=b.reason||v.scheduleNotification(b.previousVersion,"install"==b.reason)):D.registerLateCallback(function(){a(b)})},g=function(){var a=m(),b=function(){var b=Date.now(),c=r.getValue(p.CONSTANTS.STORAGE.LAST_START,
0),b=Math.round((b-c)/1E3),c=b<=p.MISC.DISTURBANCE_ALLOWED;n.debug("upd: restart?",c,"(",b,"seconds ago)");a.resolve(c)};D.late?b():D.registerLateCallback(b);return a.promise()}(),f=function(){var a=!1,c=!1;b().then(function(a){c=a;return g}).then(function(b){a=b}).always(function(){l=!c||a;d();u=!0})},q=null,u=!1,v={scheduleNotification:function(a,b){u||(t=a,h|=b,q&&window.clearTimeout(q),q=window.setTimeout(f,1E3))}};rea.runtime.onInstalled.addListener(a);rea.runtime.onUpdateAvailable.addListener(function(a){n.info("An update to version",
a.version,"is available");window.setTimeout(function(){Q.show(c.getMessage("Update"),c.getMessage("0name0_0version0_is_available__Please_re_start_your_browser_to_update_",rea.extension.manifest.name,a.version),rea.extension.getURL("images/icon128.png"),6E4)},864E5)});(function(){D.registerLateCallback(function(){r.setValue(p.CONSTANTS.STORAGE.LAST_START,Date.now())})})();return v}(),Ha=function(c){"toggle-enable"==c&&(k.values.enabled=!k.values.enabled)},pa=function(){var c=[],m=function(d,b,a){D.late?
("auto"==k.values.scriptUrlDetection&&ka.isScriptUrl(a.url)&&t.installFromUrl(a.url),a.url?"loading"==b.status?C.events.loading(a.id,0,a.url):"complete"==b.status&&C.events.complete(a.id,0,a.url):n.warn("tabUpdates: no tab url set! ",a),c.forEach(function(c){c({reason:"updated",status:b.status},a)})):window.setTimeout(function(){m(d,b,a)},100)},h=function(d,b){W[d]&&(W[d].onClose(),delete W[d]);C.events.remove(d);c.forEach(function(a){a({reason:"removed"},{id:d})})},l=function(d,b){h(b,{});S.setIcon(d);
S.setBadge(d);c.forEach(function(a){a({reason:"replaced"},d)})};return{init:function(){rea.tabs.onUpdated.addListener(m);rea.tabs.onRemoved.addListener(h);rea.tabs.onReplaced.addListener(l)},addListener:function(d){c.push(d)},removeListener:function(d){var b;c&&-1<(b=c.indexOf(d))&&c.splice(b,1)}}}(),wa=function(){var c="temporary"==k.values.incognito_mode&&rea.extension.inIncognitoContext;r.setTemporary(c);c&&(k.values.native_import=!1,k.values.sync_enabled=!1,k.values.scriptUpdateCheckPeriod=0,
k.values.sync_type=0,k.values.statistics_enabled=!1)},Ia=function(){n.set(k.values.logLevel);c.setLocale(k.values.i18n);M.setPath(k.values.native_import_path);L.init("bg",rea.extension.manifest.version);L.setEnabled(k.values.statistics_enabled);C.listeners.add.onReset(function(c,e){ba.clearByTabId(c);A.removeStorageListeners({tabid:c},!1);e||S.setIcon(c)});var e=function(c){S.setIcon(c);S.setBadge(c)};C.listeners.add.onCommited(e);C.listeners.add.onCompleted(e);C.listeners.add.onCompleted(ea.purgeAppeals);
C.listeners.add.onRemoved(ea.purgeAppeals);G.init().done(function(c){c&&G.sync()});X.init();R.init();A.init();e=function(){I.set_mode(k.values.downloads_mode);I.set_whitelist(k.values.downloads_extension_whitelist)};e();I.config_changed_listener=e;Fa.init();ma.init();qa.init();ha.init();aa.init();Z.init()},H,ia,la,ja,y,F,fa;init=function(){D.init();qa.init(!0);pa.init();ta.init();rea.commands.supported&&rea.commands.onCommand.addListener(Ha);Ga.init(function(){G.finalize()});H=Registry.get("convert");
la=Registry.get("xmlhttprequest",qa.getPrefix(),p.RUNTIME.FIREFOX);ia=la.run;ja=Registry.get("compat",p);y=Registry.get("parser");F=Registry.get("syncinfo");fa=Registry.get("test");rea.browserAction.setIcon({path:rea.extension.getURL("images/icon_grey.png")});rea.browserAction.setPopup({popup:"action.html"});rea.browserAction.setTitle({title:"Tampermonkey"});r.init().then(function(){return Ba()}).then(function(){return k.init()}).then(function(){cfgo=k;wa();Ia();Da();S.init();window.setTimeout(Z.check,
1E4);n.debug("Listeners registered!");window.setTimeout(D.setReady,1);if(fa&&Registry.isDevVersion("test")){var c=fa.framework.prepare(t.doSave,p.RUNTIME.BROWSER,p.RUNTIME.BROWSER_VERSION);c&&n.error(c)}})};init()}});
